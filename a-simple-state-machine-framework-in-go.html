<!DOCTYPE html>
<html>
<head>

    <!-- Document Settings -->
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />

    <!-- Base Meta -->
    <!-- dynamically fixing the title for tag/author pages -->



    <title>A Simple State Machine Framework in Go</title>
    <meta name="HandheldFriendly" content="True" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <!-- Styles'n'Scripts -->
    <link rel="stylesheet" type="text/css" href="/assets/built/screen.css" />
    <link rel="stylesheet" type="text/css" href="/assets/built/screen.edited.css" />
    <link rel="stylesheet" type="text/css" href="/assets/built/syntax.css" />
    <!-- highlight.js -->
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/default.min.css">
    <style>.hljs { background: none; }</style>

    <!-- This tag outputs SEO meta+structured data and other important settings -->
    <meta name="description" content="Service mesh, distributed systems, software design, and more..." />
    <link rel="shortcut icon" href="https://venilnoronha.io/assets/images/favicon.png" type="image/png" />
    <link rel="canonical" href="https://venilnoronha.io/a-simple-state-machine-framework-in-go" />
    <meta name="referrer" content="no-referrer-when-downgrade" />

     <!--title below is coming from _includes/dynamic_title-->
    <meta property="og:site_name" content="Venil Noronha" />
    <meta property="og:type" content="website" />
    <meta property="og:title" content="A Simple State Machine Framework in Go" />
    <meta property="og:description" content="The concept of State Machines is not new, and they form the core of a lot of systems that we come across daily, for example, elevators and traffic lights. State machines make it a lot easy to understand and implement multi-faceted systems where inputs can be asynchronous and are triggered" />
    <meta property="og:url" content="https://venilnoronha.io/a-simple-state-machine-framework-in-go" />
    <meta property="og:image" content="https://venilnoronha.io/assets/images/2020-05-24-a-simple-state-machine-framework-in-go/banner.jpg" />
    <meta property="article:publisher" content="https://www.facebook.com/false" />
    <meta property="article:author" content="https://www.facebook.com/false" />
    <meta property="article:published_time" content="2020-05-24T23:51:00+00:00" />
    <meta property="article:modified_time" content="2020-05-24T23:51:00+00:00" />
    <meta property="article:tag" content="Distributed Systems" />
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content="A Simple State Machine Framework in Go" />
    <meta name="twitter:description" content="The concept of State Machines is not new, and they form the core of a lot of systems that we come across daily, for example, elevators and traffic lights. State machines make it a lot easy to understand and implement multi-faceted systems where inputs can be asynchronous and are triggered" />
    <meta name="twitter:url" content="https://venilnoronha.io/" />
    <meta name="twitter:image" content="https://venilnoronha.io/assets/images/2020-05-24-a-simple-state-machine-framework-in-go/banner.jpg" />
    <meta name="twitter:label1" content="Written by" />
    <meta name="twitter:data1" content="Venil Noronha" />
    <meta name="twitter:label2" content="Filed under" />
    <meta name="twitter:data2" content="Distributed Systems" />
    <meta name="twitter:site" content="@venilnoronha" />
    <meta name="twitter:creator" content="@venilnoronha" />
    <meta property="og:image:width" content="1400" />
    <meta property="og:image:height" content="933" />

    <script type="application/ld+json">
{
    "@context": "https://schema.org",
    "@type": "Website",
    "publisher": {
        "@type": "Organization",
        "name": "Venil Noronha",
        "logo": "https://venilnoronha.io/false"
    },
    "url": "https://venilnoronha.io/a-simple-state-machine-framework-in-go",
    "image": {
        "@type": "ImageObject",
        "url": "https://venilnoronha.io/assets/images/2020-05-24-a-simple-state-machine-framework-in-go/banner.jpg",
        "width": 2000,
        "height": 666
    },
    "mainEntityOfPage": {
        "@type": "WebPage",
        "@id": "https://venilnoronha.io/a-simple-state-machine-framework-in-go"
    },
    "description": "The concept of State Machines is not new, and they form the core of a lot of systems that we come across daily, for example, elevators and traffic lights. State machines make it a lot easy to understand and implement multi-faceted systems where inputs can be asynchronous and are triggered"
}
    </script>

    <!-- <script type="text/javascript" src="https://demo.ghost.io/public/ghost-sdk.min.js?v=724281a32e"></script>
    <script type="text/javascript">
    ghost.init({
    	clientId: "ghost-frontend",
    	clientSecret: "f84a07a72b17"
    });
    </script> -->

    <meta name="generator" content="Jekyll 3.6.2" />
    <link rel="alternate" type="application/rss+xml" title="A Simple State Machine Framework in Go" href="/feed.xml" />


</head>
<body class="post-template">

    <div class="site-wrapper">
        <!-- All the main content gets inserted here, index.hbs, post.hbs, etc -->
        <!-- default -->

<!-- The tag above means: insert everything in this file
into the {body} of the default.hbs template -->

<header class="site-header outer">
    <div class="inner">
        <nav class="site-nav">
    <div class="site-nav-left">
        
            
                <a class="site-nav-logo" href="https://venilnoronha.io/">Venil Noronha</a>
            
        
        
            <ul class="nav" role="menu">
    <li class="nav-home" role="menuitem"><a href="/">Home</a></li>
    <li class="nav-talks" role="menuitem"><a href="/talks/">Talks</a></li>
    <li class="nav-about" role="menuitem"><a href="/about/">About</a></li>
    <li class="nav-feed" role="menuitem"><a href="https://venilnoronha.io/feed.xml">Feed</a></li>
</ul>

        
    </div>
    <div class="site-nav-right">
        <div class="social-links">
            
                <a class="social-link" href="https://github.com/venilnoronha" target="_blank" rel="noopener"><svg viewBox="0 0 1792 1792" xmlns="http://www.w3.org/2000/svg"><path d="M896 128q209 0 385.5 103t279.5 279.5 103 385.5q0 251-146.5 451.5t-378.5 277.5q-27 5-40-7t-13-30q0-3 .5-76.5t.5-134.5q0-97-52-142 57-6 102.5-18t94-39 81-66.5 53-105 20.5-150.5q0-119-79-206 37-91-8-204-28-9-81 11t-92 44l-38 24q-93-26-192-26t-192 26q-16-11-42.5-27t-83.5-38.5-85-13.5q-45 113-8 204-79 87-79 206 0 85 20.5 150t52.5 105 80.5 67 94 39 102.5 18q-39 36-49 103-21 10-45 15t-57 5-65.5-21.5-55.5-62.5q-19-32-48.5-52t-49.5-24l-20-3q-21 0-29 4.5t-5 11.5 9 14 13 12l7 5q22 10 43.5 38t31.5 51l10 23q13 38 44 61.5t67 30 69.5 7 55.5-3.5l23-4q0 38 .5 88.5t.5 54.5q0 18-13 30t-40 7q-232-77-378.5-277.5t-146.5-451.5q0-209 103-385.5t279.5-279.5 385.5-103zm-477 1103q3-7-7-12-10-3-13 2-3 7 7 12 9 6 13-2zm31 34q7-5-2-16-10-9-16-3-7 5 2 16 10 10 16 3zm30 45q9-7 0-19-8-13-17-6-9 5 0 18t17 7zm42 42q8-8-4-19-12-12-20-3-9 8 4 19 12 12 20 3zm57 25q3-11-13-16-15-4-19 7t13 15q15 6 19-6zm63 5q0-13-17-11-16 0-16 11 0 13 17 11 16 0 16-11zm58-10q-2-11-18-9-16 3-14 15t18 8 14-14z"/></svg>
</a>
            
            
            
                <a class="social-link social-link-tw" href="https://twitter.com/venilnoronha" target="_blank" rel="noopener"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 32 32"><path d="M30.063 7.313c-.813 1.125-1.75 2.125-2.875 2.938v.75c0 1.563-.188 3.125-.688 4.625a15.088 15.088 0 0 1-2.063 4.438c-.875 1.438-2 2.688-3.25 3.813a15.015 15.015 0 0 1-4.625 2.563c-1.813.688-3.75 1-5.75 1-3.25 0-6.188-.875-8.875-2.625.438.063.875.125 1.375.125 2.688 0 5.063-.875 7.188-2.5-1.25 0-2.375-.375-3.375-1.125s-1.688-1.688-2.063-2.875c.438.063.813.125 1.125.125.5 0 1-.063 1.5-.25-1.313-.25-2.438-.938-3.313-1.938a5.673 5.673 0 0 1-1.313-3.688v-.063c.813.438 1.688.688 2.625.688a5.228 5.228 0 0 1-1.875-2c-.5-.875-.688-1.813-.688-2.75 0-1.063.25-2.063.75-2.938 1.438 1.75 3.188 3.188 5.25 4.25s4.313 1.688 6.688 1.813a5.579 5.579 0 0 1 1.5-5.438c1.125-1.125 2.5-1.688 4.125-1.688s3.063.625 4.188 1.813a11.48 11.48 0 0 0 3.688-1.375c-.438 1.375-1.313 2.438-2.563 3.188 1.125-.125 2.188-.438 3.313-.875z"/></svg>
</a>
            
            
            
                <a class="social-link" href="https://linkedin.com/in/venilnoronha" target="_blank" rel="noopener"><svg viewBox="0 0 1792 1792" xmlns="http://www.w3.org/2000/svg"><path d="M365 1414h231v-694h-231v694zm246-908q-1-52-36-86t-93-34-94.5 34-36.5 86q0 51 35.5 85.5t92.5 34.5h1q59 0 95-34.5t36-85.5zm585 908h231v-398q0-154-73-233t-193-79q-136 0-209 117h2v-101h-231q3 66 0 694h231v-388q0-38 7-56 15-35 45-59.5t74-24.5q116 0 116 157v371zm468-998v960q0 119-84.5 203.5t-203.5 84.5h-960q-119 0-203.5-84.5t-84.5-203.5v-960q0-119 84.5-203.5t203.5-84.5h960q119 0 203.5 84.5t84.5 203.5z"/></svg>
</a>
            
        </div>
        
    </div>
</nav>

    </div>
</header>

<!-- Everything inside the #post tags pulls data from the post -->
<!-- #post -->

<main id="site-main" class="site-main outer" role="main">
    <div class="inner">

        <article class="post-full post tag-distributed-systems ">

            <header class="post-full-header">
                <section class="post-full-meta">
                    <time class="post-full-meta-date" datetime="24 May 2020">24 May 2020</time>
                    
                        <span class="date-divider">/</span>
                        
                            
                               <a href='/tag/distributed-systems/'>DISTRIBUTED SYSTEMS</a>
                            
                        
                    
                </section>
                <h1 class="post-full-title">A Simple State Machine Framework in Go</h1>
            </header>

            
            <figure class="post-full-image" style="background-image: url(/assets/images/2020-05-24-a-simple-state-machine-framework-in-go/banner.jpg)">
            </figure>
            

            <section class="post-full-content">
                <div class="kg-card-markdown">
                    <p>The concept of <a href="https://en.wikipedia.org/wiki/Finite-state_machine">State Machines</a> is not new, and
they form the core of a lot of systems that we come across daily, for example, elevators and traffic
lights. State machines make it a lot easy to understand and implement multi-faceted systems where
inputs can be asynchronous and are triggered by multiple sources.</p>

<p>In this post, I will describe the details of a simple state machine framework that I built to handle
a complex scenario to obtain deterministic results.</p>

<h2 id="introduction">Introduction</h2>

<p>State machines are of several different types and newer models (like Statecharts) have also been
designed in order to handle extremely complicated systems. The fundamentals of all of these patterns
remain the same i.e. they consist of <i>states</i> and <i>transitions</i>. For the purpose of this
post, I’ll be using the term <i>state</i> to describe the status of the system, and <i>event</i> to
describe an input to the FSM (Finite State Machine) that can possibly trigger a transition from one
state to another.</p>

<h2 id="light-switch-example">Light Switch Example</h2>

<p style="text-align: center;">
  <img src="assets/images/2020-05-24-a-simple-state-machine-framework-in-go/light-switch-fsm.png" alt="Light Switch FSM" style="width: 60%; display: inline-block;" />
</p>

<p>Let’s take a simple example of the light switch state machine that’s shown above. The machine starts
in the <i>off</i> state and the user action of switching on i.e. triggering the <i>switch-on</i>
event, causes the machine to transition over to the <i>on</i> state. And the reverse is also
true, i.e. on triggering the <i>switch-off</i> event, the machine then transitiona back from the
<i>on</i> state back to the <i>off</i> state. Note that triggering the <i>switch-off</i> event when
in the <i>off</i> state means nothing i.e. the machine doesn’t react to it, and the same is also
true when the <i>switch-on</i> event is triggered when the system is in the <i>on</i> state.</p>

<h2 id="the-framework">The Framework</h2>

<p>Here is the framework in Go in under 100 lines of code.</p>

<div class="language-golang highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">// ErrEventRejected is the error returned when the state machine cannot process</span>
<span class="c">// an event in the state that it is in.</span>
<span class="k">var</span> <span class="n">ErrEventRejected</span> <span class="o">=</span> <span class="n">errors</span><span class="o">.</span><span class="n">New</span><span class="p">(</span><span class="s">"event rejected"</span><span class="p">)</span>

<span class="k">const</span> <span class="p">(</span>
	<span class="c">// Default represents the default state of the system.</span>
	<span class="n">Default</span> <span class="n">StateType</span> <span class="o">=</span> <span class="s">""</span>

	<span class="c">// NoOp represents a no-op event.</span>
	<span class="n">NoOp</span> <span class="n">EventType</span> <span class="o">=</span> <span class="s">"NoOp"</span>
<span class="p">)</span>

<span class="c">// StateType represents an extensible state type in the state machine.</span>
<span class="k">type</span> <span class="n">StateType</span> <span class="kt">string</span>

<span class="c">// EventType represents an extensible event type in the state machine.</span>
<span class="k">type</span> <span class="n">EventType</span> <span class="kt">string</span>

<span class="c">// EventContext represents the context to be passed to the action implementation.</span>
<span class="k">type</span> <span class="n">EventContext</span> <span class="k">interface</span><span class="p">{}</span>

<span class="c">// Action represents the action to be executed in a given state.</span>
<span class="k">type</span> <span class="n">Action</span> <span class="k">interface</span> <span class="p">{</span>
	<span class="n">Execute</span><span class="p">(</span><span class="n">eventCtx</span> <span class="n">EventContext</span><span class="p">)</span> <span class="n">EventType</span>
<span class="p">}</span>

<span class="c">// Events represents a mapping of events and states.</span>
<span class="k">type</span> <span class="n">Events</span> <span class="k">map</span><span class="p">[</span><span class="n">EventType</span><span class="p">]</span><span class="n">StateType</span>

<span class="c">// State binds a state with an action and a set of events it can handle.</span>
<span class="k">type</span> <span class="n">State</span> <span class="k">struct</span> <span class="p">{</span>
	<span class="n">Action</span> <span class="n">Action</span>
	<span class="n">Events</span> <span class="n">Events</span>
<span class="p">}</span>

<span class="c">// States represents a mapping of states and their implementations.</span>
<span class="k">type</span> <span class="n">States</span> <span class="k">map</span><span class="p">[</span><span class="n">StateType</span><span class="p">]</span><span class="n">State</span>

<span class="c">// StateMachine represents the state machine.</span>
<span class="k">type</span> <span class="n">StateMachine</span> <span class="k">struct</span> <span class="p">{</span>
	<span class="c">// Previous represents the previous state.</span>
	<span class="n">Previous</span> <span class="n">StateType</span>

	<span class="c">// Current represents the current state.</span>
	<span class="n">Current</span> <span class="n">StateType</span>

	<span class="c">// States holds the configuration of states and events handled by the state machine.</span>
	<span class="n">States</span> <span class="n">States</span>

	<span class="c">// mutex ensures that only 1 event is processed by the state machine at any given time.</span>
	<span class="n">mutex</span> <span class="n">sync</span><span class="o">.</span><span class="n">Mutex</span>
<span class="p">}</span>

<span class="c">// getNextState returns the next state for the event given the machine's current</span>
<span class="c">// state, or an error if the event can't be handled in the given state.</span>
<span class="k">func</span> <span class="p">(</span><span class="n">s</span> <span class="o">*</span><span class="n">StateMachine</span><span class="p">)</span> <span class="n">getNextState</span><span class="p">(</span><span class="n">event</span> <span class="n">EventType</span><span class="p">)</span> <span class="p">(</span><span class="n">StateType</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">if</span> <span class="n">state</span><span class="p">,</span> <span class="n">ok</span> <span class="o">:=</span> <span class="n">s</span><span class="o">.</span><span class="n">States</span><span class="p">[</span><span class="n">s</span><span class="o">.</span><span class="n">Current</span><span class="p">];</span> <span class="n">ok</span> <span class="p">{</span>
		<span class="k">if</span> <span class="n">state</span><span class="o">.</span><span class="n">Events</span> <span class="o">!=</span> <span class="no">nil</span> <span class="p">{</span>
			<span class="k">if</span> <span class="n">next</span><span class="p">,</span> <span class="n">ok</span> <span class="o">:=</span> <span class="n">state</span><span class="o">.</span><span class="n">Events</span><span class="p">[</span><span class="n">event</span><span class="p">];</span> <span class="n">ok</span> <span class="p">{</span>
				<span class="k">return</span> <span class="n">next</span><span class="p">,</span> <span class="no">nil</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">Default</span><span class="p">,</span> <span class="n">ErrEventRejected</span>
<span class="p">}</span>

<span class="c">// SendEvent sends an event to the state machine.</span>
<span class="k">func</span> <span class="p">(</span><span class="n">s</span> <span class="o">*</span><span class="n">StateMachine</span><span class="p">)</span> <span class="n">SendEvent</span><span class="p">(</span><span class="n">event</span> <span class="n">EventType</span><span class="p">,</span> <span class="n">eventCtx</span> <span class="n">EventContext</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
	<span class="n">s</span><span class="o">.</span><span class="n">mutex</span><span class="o">.</span><span class="n">Lock</span><span class="p">()</span>
	<span class="k">defer</span> <span class="n">s</span><span class="o">.</span><span class="n">mutex</span><span class="o">.</span><span class="n">Unlock</span><span class="p">()</span>

	<span class="k">for</span> <span class="p">{</span>
		<span class="c">// Determine the next state for the event given the machine's current state.</span>
		<span class="n">nextState</span><span class="p">,</span> <span class="n">err</span> <span class="o">:=</span> <span class="n">s</span><span class="o">.</span><span class="n">getNextState</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
		<span class="k">if</span> <span class="n">err</span> <span class="o">!=</span> <span class="no">nil</span> <span class="p">{</span>
			<span class="k">return</span> <span class="n">ErrEventRejected</span>
		<span class="p">}</span>

		<span class="c">// Identify the state definition for the next state.</span>
		<span class="n">state</span><span class="p">,</span> <span class="n">ok</span> <span class="o">:=</span> <span class="n">s</span><span class="o">.</span><span class="n">States</span><span class="p">[</span><span class="n">nextState</span><span class="p">]</span>
		<span class="k">if</span> <span class="o">!</span><span class="n">ok</span> <span class="o">||</span> <span class="n">state</span><span class="o">.</span><span class="n">Action</span> <span class="o">==</span> <span class="no">nil</span> <span class="p">{</span>
			<span class="c">// configuration error</span>
		<span class="p">}</span>

		<span class="c">// Transition over to the next state.</span>
		<span class="n">s</span><span class="o">.</span><span class="n">Previous</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">Current</span>
		<span class="n">s</span><span class="o">.</span><span class="n">Current</span> <span class="o">=</span> <span class="n">nextState</span>

		<span class="c">// Execute the next state's action and loop over again if the event returned</span>
		<span class="c">// is not a no-op.</span>
		<span class="n">nextEvent</span> <span class="o">:=</span> <span class="n">state</span><span class="o">.</span><span class="n">Action</span><span class="o">.</span><span class="n">Execute</span><span class="p">(</span><span class="n">eventCtx</span><span class="p">)</span>
		<span class="k">if</span> <span class="n">nextEvent</span> <span class="o">==</span> <span class="n">NoOp</span> <span class="p">{</span>
			<span class="k">return</span> <span class="no">nil</span>
		<span class="p">}</span>
		<span class="n">event</span> <span class="o">=</span> <span class="n">nextEvent</span>
	<span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>For the sake of brevity, I’ve skipped over database handling in this post. It’s also quite easy to
wire into this state machine framework.</p>

<h2 id="light-switch-example-in-go">Light Switch Example in Go</h2>

<p>Here is the same light switch example from above, but this time implemented using the Go framework.
Let’s first define the states and events for the light switch state machine.</p>

<div class="language-golang highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">const</span> <span class="p">(</span>
	<span class="n">Off</span> <span class="n">StateType</span> <span class="o">=</span> <span class="s">"Off"</span>
	<span class="n">On</span>  <span class="n">StateType</span> <span class="o">=</span> <span class="s">"On"</span>

	<span class="n">SwitchOff</span> <span class="n">EventType</span> <span class="o">=</span> <span class="s">"SwitchOff"</span>
	<span class="n">SwitchOn</span>  <span class="n">EventType</span> <span class="o">=</span> <span class="s">"SwitchOn"</span>
<span class="p">)</span>
</code></pre></div></div>

<p>We can now also define the actions corresponding to each state.</p>

<div class="language-golang highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">// OffAction represents the action executed on entering the Off state.</span>
<span class="k">type</span> <span class="n">OffAction</span> <span class="k">struct</span><span class="p">{}</span>

<span class="k">func</span> <span class="p">(</span><span class="n">a</span> <span class="o">*</span><span class="n">OffAction</span><span class="p">)</span> <span class="n">Execute</span><span class="p">(</span><span class="n">eventCtx</span> <span class="n">EventContext</span><span class="p">)</span> <span class="n">EventType</span> <span class="p">{</span>
	<span class="n">fmt</span><span class="o">.</span><span class="n">Println</span><span class="p">(</span><span class="s">"The light has been switched off"</span><span class="p">)</span>
	<span class="k">return</span> <span class="n">NoOp</span>
<span class="p">}</span>

<span class="c">// OnAction represents the action executed on entering the On state.</span>
<span class="k">type</span> <span class="n">OnAction</span> <span class="k">struct</span><span class="p">{}</span>

<span class="k">func</span> <span class="p">(</span><span class="n">a</span> <span class="o">*</span><span class="n">OnAction</span><span class="p">)</span> <span class="n">Execute</span><span class="p">(</span><span class="n">eventCtx</span> <span class="n">EventContext</span><span class="p">)</span> <span class="n">EventType</span> <span class="p">{</span>
	<span class="n">fmt</span><span class="o">.</span><span class="n">Println</span><span class="p">(</span><span class="s">"The light has been switched on"</span><span class="p">)</span>
	<span class="k">return</span> <span class="n">NoOp</span>
<span class="p">}</span>
</code></pre></div></div>

<p>We can now define our state machine using the previously defined states, events and actions.</p>

<div class="language-golang highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">func</span> <span class="n">newLightSwitchFSM</span><span class="p">()</span> <span class="o">*</span><span class="n">StateMachine</span> <span class="p">{</span>
  <span class="k">return</span> <span class="o">&amp;</span><span class="n">StateMachine</span><span class="p">{</span>
		<span class="n">States</span><span class="o">:</span> <span class="n">States</span><span class="p">{</span>
			<span class="n">Default</span><span class="o">:</span> <span class="n">State</span><span class="p">{</span>
				<span class="n">Events</span><span class="o">:</span> <span class="n">Events</span><span class="p">{</span>
					<span class="n">SwitchOff</span><span class="o">:</span> <span class="n">Off</span><span class="p">,</span>
				<span class="p">},</span>
			<span class="p">},</span>
			<span class="n">Off</span><span class="o">:</span> <span class="n">State</span><span class="p">{</span>
				<span class="n">Action</span><span class="o">:</span> <span class="o">&amp;</span><span class="n">OffAction</span><span class="p">{},</span>
				<span class="n">Events</span><span class="o">:</span> <span class="n">Events</span><span class="p">{</span>
					<span class="n">SwitchOn</span><span class="o">:</span> <span class="n">On</span><span class="p">,</span>
				<span class="p">},</span>
			<span class="p">},</span>
			<span class="n">On</span><span class="o">:</span> <span class="n">State</span><span class="p">{</span>
				<span class="n">Action</span><span class="o">:</span> <span class="o">&amp;</span><span class="n">OnAction</span><span class="p">{},</span>
				<span class="n">Events</span><span class="o">:</span> <span class="n">Events</span><span class="p">{</span>
					<span class="n">SwitchOff</span><span class="o">:</span> <span class="n">Off</span><span class="p">,</span>
				<span class="p">},</span>
			<span class="p">},</span>
		<span class="p">},</span>
	<span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Let’s now put our light switch state machine to test.</p>

<div class="language-golang highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">func</span> <span class="n">TestLightSwitchStateMachine</span><span class="p">(</span><span class="n">t</span> <span class="o">*</span><span class="n">testing</span><span class="o">.</span><span class="n">T</span><span class="p">)</span> <span class="p">{</span>
	<span class="c">// Create a new instance of the light switch state machine.</span>
	<span class="n">lightSwitchFsm</span> <span class="o">:=</span> <span class="n">newLightSwitchFSM</span><span class="p">()</span>

	<span class="c">// Set the initial "off" state in the state machine.</span>
	<span class="n">err</span> <span class="o">:=</span> <span class="n">lightSwitchFsm</span><span class="o">.</span><span class="n">SendEvent</span><span class="p">(</span><span class="n">SwitchOff</span><span class="p">,</span> <span class="no">nil</span><span class="p">)</span>
	<span class="k">if</span> <span class="n">err</span> <span class="o">!=</span> <span class="no">nil</span> <span class="p">{</span>
		<span class="n">t</span><span class="o">.</span><span class="n">Errorf</span><span class="p">(</span><span class="s">"Couldn't set the initial state of the state machine, err: %v"</span><span class="p">,</span> <span class="n">err</span><span class="p">)</span>
	<span class="p">}</span>

	<span class="c">// Send the switch-off event again and expect the state machine to return an error.</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">lightSwitchFsm</span><span class="o">.</span><span class="n">SendEvent</span><span class="p">(</span><span class="n">SwitchOff</span><span class="p">,</span> <span class="no">nil</span><span class="p">)</span>
	<span class="k">if</span> <span class="n">err</span> <span class="o">!=</span> <span class="n">ErrEventRejected</span> <span class="p">{</span>
		<span class="n">t</span><span class="o">.</span><span class="n">Errorf</span><span class="p">(</span><span class="s">"Expected the event rejected error, got nil"</span><span class="p">)</span>
	<span class="p">}</span>

	<span class="c">// Send the switch-on event and expect the state machine to transition to the</span>
	<span class="c">// "on" state.</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">lightSwitchFsm</span><span class="o">.</span><span class="n">SendEvent</span><span class="p">(</span><span class="n">SwitchOn</span><span class="p">,</span> <span class="no">nil</span><span class="p">)</span>
	<span class="k">if</span> <span class="n">err</span> <span class="o">!=</span> <span class="no">nil</span> <span class="p">{</span>
		<span class="n">t</span><span class="o">.</span><span class="n">Errorf</span><span class="p">(</span><span class="s">"Couldn't switch the light on, err: %v"</span><span class="p">,</span> <span class="n">err</span><span class="p">)</span>
	<span class="p">}</span>

	<span class="c">// Send the switch-on event again and expect the state machine to return an error.</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">lightSwitchFsm</span><span class="o">.</span><span class="n">SendEvent</span><span class="p">(</span><span class="n">SwitchOn</span><span class="p">,</span> <span class="no">nil</span><span class="p">)</span>
	<span class="k">if</span> <span class="n">err</span> <span class="o">!=</span> <span class="n">ErrEventRejected</span> <span class="p">{</span>
		<span class="n">t</span><span class="o">.</span><span class="n">Errorf</span><span class="p">(</span><span class="s">"Expected the event rejected error, got nil"</span><span class="p">)</span>
	<span class="p">}</span>

	<span class="c">// Send the switch-off event and expect the state machine to transition back</span>
	<span class="c">// to the "off" state.</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">lightSwitchFsm</span><span class="o">.</span><span class="n">SendEvent</span><span class="p">(</span><span class="n">SwitchOff</span><span class="p">,</span> <span class="no">nil</span><span class="p">)</span>
	<span class="k">if</span> <span class="n">err</span> <span class="o">!=</span> <span class="no">nil</span> <span class="p">{</span>
		<span class="n">t</span><span class="o">.</span><span class="n">Errorf</span><span class="p">(</span><span class="s">"Couldn't switch the light off, err: %v"</span><span class="p">,</span> <span class="n">err</span><span class="p">)</span>
	<span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>As you see above, the whole state machine becomes very clear just by looking at the <code class="language-plaintext highlighter-rouge">lightSwitchFsm</code>
definition. The <code class="language-plaintext highlighter-rouge">OffAction</code> and <code class="language-plaintext highlighter-rouge">OnAction</code> implement the <code class="language-plaintext highlighter-rouge">Action</code> interface from the framework and
in this simple example they both print a statement to <i>stdout</i>. Events are sent to the state
machine using statements like <code class="language-plaintext highlighter-rouge">lightSwitchFsm.SendEvent(SwitchOn, nil)</code> where the first parameter is
the event itself and the second parameter represents the <code class="language-plaintext highlighter-rouge">EventContext</code>. In this example, there
is no need for passing any context, so we send <code class="language-plaintext highlighter-rouge">nil</code>, but we will also see another example that
showcases its usage.</p>

<p>Following is the output from executing the above test.</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">===</span> RUN   TestLightSwitchStateMachine
The light has been switched off
The light has been switched on
The light has been switched off
<span class="nt">---</span> PASS: TestLightSwitchStateMachine <span class="o">(</span>0.00s<span class="o">)</span>
</code></pre></div></div>

<p>As expected, the state machine transitions to the initial <i>off</i> state, then to the <i>on</i>
state and finally back to the <i>off</i> state, rejecting any events that it can’t handle according
to the definition of the state machine and the state that it is in when the event arrives.</p>

<h2 id="order-processing-example-in-go">Order Processing Example in Go</h2>

<p style="text-align: center;">
  <img src="assets/images/2020-05-24-a-simple-state-machine-framework-in-go/order-processing-fsm.png" alt="Order Processing FSM" style="display: inline-block;" />
</p>

<p>Here is a slightly fancier state machine example of order processing. The state machine starts in
the <i>order creating</i> state where it validates the order details (passed via <code class="language-plaintext highlighter-rouge">EventContext</code>). It
then can transition to the <i>order created</i> state if the order is valid, and if not, it
transitions over to the <i>order failed</i> state. Then another event is sent to it externally for
charging the user’s card and shipping the order. The state machine here transitions to the <i>
charging card</i> state, and if the card is valid, transitions over to the <i>order shipped</i>
state, and if not, to the <i>transaction failed</i> state.</p>

<p>To implement this in Go, we first define the set of states and events as in the previous example.</p>

<div class="language-golang highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">const</span> <span class="p">(</span>
	<span class="n">CreatingOrder</span>     <span class="n">StateType</span> <span class="o">=</span> <span class="s">"CreatingOrder"</span>
	<span class="n">OrderFailed</span>       <span class="n">StateType</span> <span class="o">=</span> <span class="s">"OrderFailed"</span>
	<span class="n">OrderPlaced</span>       <span class="n">StateType</span> <span class="o">=</span> <span class="s">"OrderPlaced"</span>
	<span class="n">ChargingCard</span>      <span class="n">StateType</span> <span class="o">=</span> <span class="s">"ChargingCard"</span>
	<span class="n">TransactionFailed</span> <span class="n">StateType</span> <span class="o">=</span> <span class="s">"TransactionFailed"</span>
	<span class="n">OrderShipped</span>      <span class="n">StateType</span> <span class="o">=</span> <span class="s">"OrderShipped"</span>

	<span class="n">CreateOrder</span>     <span class="n">EventType</span> <span class="o">=</span> <span class="s">"CreateOrder"</span>
	<span class="n">FailOrder</span>       <span class="n">EventType</span> <span class="o">=</span> <span class="s">"FailOrder"</span>
	<span class="n">PlaceOrder</span>      <span class="n">EventType</span> <span class="o">=</span> <span class="s">"PlaceOrder"</span>
	<span class="n">ChargeCard</span>      <span class="n">EventType</span> <span class="o">=</span> <span class="s">"ChargeCard"</span>
	<span class="n">FailTransaction</span> <span class="n">EventType</span> <span class="o">=</span> <span class="s">"FailTransaction"</span>
	<span class="n">ShipOrder</span>       <span class="n">EventType</span> <span class="o">=</span> <span class="s">"ShipOrder"</span>
<span class="p">)</span>
</code></pre></div></div>

<p>This time we also define special context types for the purpose of passing data
to event actions.</p>

<div class="language-golang highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">type</span> <span class="n">OrderCreationContext</span> <span class="k">struct</span> <span class="p">{</span>
	<span class="n">items</span> <span class="p">[]</span><span class="kt">string</span>
	<span class="n">err</span>   <span class="kt">error</span>
<span class="p">}</span>

<span class="k">func</span> <span class="p">(</span><span class="n">c</span> <span class="o">*</span><span class="n">OrderCreationContext</span><span class="p">)</span> <span class="n">String</span><span class="p">()</span> <span class="kt">string</span> <span class="p">{</span>
	<span class="k">return</span> <span class="n">fmt</span><span class="o">.</span><span class="n">Sprintf</span><span class="p">(</span><span class="s">"OrderCreationContext [ items: %s, err: %v ]"</span><span class="p">,</span>
		<span class="n">strings</span><span class="o">.</span><span class="n">Join</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">items</span><span class="p">,</span> <span class="s">","</span><span class="p">),</span> <span class="n">c</span><span class="o">.</span><span class="n">err</span><span class="p">)</span>
<span class="p">}</span>

<span class="k">type</span> <span class="n">OrderShipmentContext</span> <span class="k">struct</span> <span class="p">{</span>
	<span class="n">cardNumber</span> <span class="kt">string</span>
	<span class="n">address</span>    <span class="kt">string</span>
	<span class="n">err</span>        <span class="kt">error</span>
<span class="p">}</span>

<span class="k">func</span> <span class="p">(</span><span class="n">c</span> <span class="o">*</span><span class="n">OrderShipmentContext</span><span class="p">)</span> <span class="n">String</span><span class="p">()</span> <span class="kt">string</span> <span class="p">{</span>
	<span class="k">return</span> <span class="n">fmt</span><span class="o">.</span><span class="n">Sprintf</span><span class="p">(</span><span class="s">"OrderShipmentContext [ cardNumber: %s, address: %s, err: %v ]"</span><span class="p">,</span>
		<span class="n">c</span><span class="o">.</span><span class="n">cardNumber</span><span class="p">,</span> <span class="n">c</span><span class="o">.</span><span class="n">address</span><span class="p">,</span> <span class="n">c</span><span class="o">.</span><span class="n">err</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div></div>

<p>We can now define actions for all our states.</p>

<div class="language-golang highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">type</span> <span class="n">CreatingOrderAction</span> <span class="k">struct</span><span class="p">{}</span>

<span class="k">func</span> <span class="p">(</span><span class="n">a</span> <span class="o">*</span><span class="n">CreatingOrderAction</span><span class="p">)</span> <span class="n">Execute</span><span class="p">(</span><span class="n">eventCtx</span> <span class="n">EventContext</span><span class="p">)</span> <span class="n">EventType</span> <span class="p">{</span>
	<span class="n">order</span> <span class="o">:=</span> <span class="n">eventCtx</span><span class="o">.</span><span class="p">(</span><span class="o">*</span><span class="n">OrderCreationContext</span><span class="p">)</span>
	<span class="n">fmt</span><span class="o">.</span><span class="n">Println</span><span class="p">(</span><span class="s">"Validating, order:"</span><span class="p">,</span> <span class="n">order</span><span class="p">)</span>
	<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">order</span><span class="o">.</span><span class="n">items</span><span class="p">)</span> <span class="o">==</span> <span class="m">0</span> <span class="p">{</span>
		<span class="n">order</span><span class="o">.</span><span class="n">err</span> <span class="o">=</span> <span class="n">errors</span><span class="o">.</span><span class="n">New</span><span class="p">(</span><span class="s">"Insufficient number of items in order"</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">FailOrder</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">PlaceOrder</span>
<span class="p">}</span>

<span class="k">type</span> <span class="n">OrderFailedAction</span> <span class="k">struct</span><span class="p">{}</span>

<span class="k">func</span> <span class="p">(</span><span class="n">a</span> <span class="o">*</span><span class="n">OrderFailedAction</span><span class="p">)</span> <span class="n">Execute</span><span class="p">(</span><span class="n">eventCtx</span> <span class="n">EventContext</span><span class="p">)</span> <span class="n">EventType</span> <span class="p">{</span>
	<span class="n">order</span> <span class="o">:=</span> <span class="n">eventCtx</span><span class="o">.</span><span class="p">(</span><span class="o">*</span><span class="n">OrderCreationContext</span><span class="p">)</span>
	<span class="n">fmt</span><span class="o">.</span><span class="n">Println</span><span class="p">(</span><span class="s">"Order failed, err:"</span><span class="p">,</span> <span class="n">order</span><span class="o">.</span><span class="n">err</span><span class="p">)</span>
	<span class="k">return</span> <span class="n">NoOp</span>
<span class="p">}</span>

<span class="k">type</span> <span class="n">OrderPlacedAction</span> <span class="k">struct</span><span class="p">{}</span>

<span class="k">func</span> <span class="p">(</span><span class="n">a</span> <span class="o">*</span><span class="n">OrderPlacedAction</span><span class="p">)</span> <span class="n">Execute</span><span class="p">(</span><span class="n">eventCtx</span> <span class="n">EventContext</span><span class="p">)</span> <span class="n">EventType</span> <span class="p">{</span>
	<span class="n">order</span> <span class="o">:=</span> <span class="n">eventCtx</span><span class="o">.</span><span class="p">(</span><span class="o">*</span><span class="n">OrderCreationContext</span><span class="p">)</span>
	<span class="n">fmt</span><span class="o">.</span><span class="n">Println</span><span class="p">(</span><span class="s">"Order placed, items:"</span><span class="p">,</span> <span class="n">order</span><span class="o">.</span><span class="n">items</span><span class="p">)</span>
	<span class="k">return</span> <span class="n">NoOp</span>
<span class="p">}</span>

<span class="k">type</span> <span class="n">ChargingCardAction</span> <span class="k">struct</span><span class="p">{}</span>

<span class="k">func</span> <span class="p">(</span><span class="n">a</span> <span class="o">*</span><span class="n">ChargingCardAction</span><span class="p">)</span> <span class="n">Execute</span><span class="p">(</span><span class="n">eventCtx</span> <span class="n">EventContext</span><span class="p">)</span> <span class="n">EventType</span> <span class="p">{</span>
	<span class="n">shipment</span> <span class="o">:=</span> <span class="n">eventCtx</span><span class="o">.</span><span class="p">(</span><span class="o">*</span><span class="n">OrderShipmentContext</span><span class="p">)</span>
	<span class="n">fmt</span><span class="o">.</span><span class="n">Println</span><span class="p">(</span><span class="s">"Validating card, shipment:"</span><span class="p">,</span> <span class="n">shipment</span><span class="p">)</span>
	<span class="k">if</span> <span class="n">shipment</span><span class="o">.</span><span class="n">cardNumber</span> <span class="o">==</span> <span class="s">""</span> <span class="p">{</span>
		<span class="n">shipment</span><span class="o">.</span><span class="n">err</span> <span class="o">=</span> <span class="n">errors</span><span class="o">.</span><span class="n">New</span><span class="p">(</span><span class="s">"Card number is invalid"</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">FailTransaction</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">ShipOrder</span>
<span class="p">}</span>

<span class="k">type</span> <span class="n">TransactionFailedAction</span> <span class="k">struct</span><span class="p">{}</span>

<span class="k">func</span> <span class="p">(</span><span class="n">a</span> <span class="o">*</span><span class="n">TransactionFailedAction</span><span class="p">)</span> <span class="n">Execute</span><span class="p">(</span><span class="n">eventCtx</span> <span class="n">EventContext</span><span class="p">)</span> <span class="n">EventType</span> <span class="p">{</span>
	<span class="n">shipment</span> <span class="o">:=</span> <span class="n">eventCtx</span><span class="o">.</span><span class="p">(</span><span class="o">*</span><span class="n">OrderShipmentContext</span><span class="p">)</span>
	<span class="n">fmt</span><span class="o">.</span><span class="n">Println</span><span class="p">(</span><span class="s">"Transaction failed, err:"</span><span class="p">,</span> <span class="n">shipment</span><span class="o">.</span><span class="n">err</span><span class="p">)</span>
	<span class="k">return</span> <span class="n">NoOp</span>
<span class="p">}</span>

<span class="k">type</span> <span class="n">OrderShippedAction</span> <span class="k">struct</span><span class="p">{}</span>

<span class="k">func</span> <span class="p">(</span><span class="n">a</span> <span class="o">*</span><span class="n">OrderShippedAction</span><span class="p">)</span> <span class="n">Execute</span><span class="p">(</span><span class="n">eventCtx</span> <span class="n">EventContext</span><span class="p">)</span> <span class="n">EventType</span> <span class="p">{</span>
	<span class="n">shipment</span> <span class="o">:=</span> <span class="n">eventCtx</span><span class="o">.</span><span class="p">(</span><span class="o">*</span><span class="n">OrderShipmentContext</span><span class="p">)</span>
	<span class="n">fmt</span><span class="o">.</span><span class="n">Println</span><span class="p">(</span><span class="s">"Order shipped, address:"</span><span class="p">,</span> <span class="n">shipment</span><span class="o">.</span><span class="n">address</span><span class="p">)</span>
	<span class="k">return</span> <span class="n">NoOp</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Let’s now define our state machine.</p>

<div class="language-golang highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">func</span> <span class="n">newOrderFSM</span><span class="p">()</span> <span class="o">*</span><span class="n">StateMachine</span> <span class="p">{</span>
	<span class="k">return</span> <span class="o">&amp;</span><span class="n">StateMachine</span><span class="p">{</span>
		<span class="n">States</span><span class="o">:</span> <span class="n">States</span><span class="p">{</span>
			<span class="n">Default</span><span class="o">:</span> <span class="n">State</span><span class="p">{</span>
				<span class="n">Events</span><span class="o">:</span> <span class="n">Events</span><span class="p">{</span>
					<span class="n">CreateOrder</span><span class="o">:</span> <span class="n">CreatingOrder</span><span class="p">,</span>
				<span class="p">},</span>
			<span class="p">},</span>
			<span class="n">CreatingOrder</span><span class="o">:</span> <span class="n">State</span><span class="p">{</span>
				<span class="n">Action</span><span class="o">:</span> <span class="o">&amp;</span><span class="n">CreatingOrderAction</span><span class="p">{},</span>
				<span class="n">Events</span><span class="o">:</span> <span class="n">Events</span><span class="p">{</span>
					<span class="n">FailOrder</span><span class="o">:</span>  <span class="n">OrderFailed</span><span class="p">,</span>
					<span class="n">PlaceOrder</span><span class="o">:</span> <span class="n">OrderPlaced</span><span class="p">,</span>
				<span class="p">},</span>
			<span class="p">},</span>
			<span class="n">OrderFailed</span><span class="o">:</span> <span class="n">State</span><span class="p">{</span>
				<span class="n">Action</span><span class="o">:</span> <span class="o">&amp;</span><span class="n">OrderFailedAction</span><span class="p">{},</span>
				<span class="n">Events</span><span class="o">:</span> <span class="n">Events</span><span class="p">{</span>
					<span class="n">CreateOrder</span><span class="o">:</span> <span class="n">CreatingOrder</span><span class="p">,</span>
				<span class="p">},</span>
			<span class="p">},</span>
			<span class="n">OrderPlaced</span><span class="o">:</span> <span class="n">State</span><span class="p">{</span>
				<span class="n">Action</span><span class="o">:</span> <span class="o">&amp;</span><span class="n">OrderPlacedAction</span><span class="p">{},</span>
				<span class="n">Events</span><span class="o">:</span> <span class="n">Events</span><span class="p">{</span>
					<span class="n">ChargeCard</span><span class="o">:</span> <span class="n">ChargingCard</span><span class="p">,</span>
				<span class="p">},</span>
			<span class="p">},</span>
			<span class="n">ChargingCard</span><span class="o">:</span> <span class="n">State</span><span class="p">{</span>
				<span class="n">Action</span><span class="o">:</span> <span class="o">&amp;</span><span class="n">ChargingCardAction</span><span class="p">{},</span>
				<span class="n">Events</span><span class="o">:</span> <span class="n">Events</span><span class="p">{</span>
					<span class="n">FailTransaction</span><span class="o">:</span> <span class="n">TransactionFailed</span><span class="p">,</span>
					<span class="n">ShipOrder</span><span class="o">:</span>       <span class="n">OrderShipped</span><span class="p">,</span>
				<span class="p">},</span>
			<span class="p">},</span>
			<span class="n">TransactionFailed</span><span class="o">:</span> <span class="n">State</span><span class="p">{</span>
				<span class="n">Action</span><span class="o">:</span> <span class="o">&amp;</span><span class="n">TransactionFailedAction</span><span class="p">{},</span>
				<span class="n">Events</span><span class="o">:</span> <span class="n">Events</span><span class="p">{</span>
					<span class="n">ChargeCard</span><span class="o">:</span> <span class="n">ChargingCard</span><span class="p">,</span>
				<span class="p">},</span>
			<span class="p">},</span>
			<span class="n">OrderShipped</span><span class="o">:</span> <span class="n">State</span><span class="p">{</span>
				<span class="n">Action</span><span class="o">:</span> <span class="o">&amp;</span><span class="n">OrderShippedAction</span><span class="p">{},</span>
			<span class="p">},</span>
		<span class="p">},</span>
	<span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Let’s put our order processing FSM to test.</p>

<div class="language-golang highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">func</span> <span class="n">TestOrderFSM</span><span class="p">(</span><span class="n">t</span> <span class="o">*</span><span class="n">testing</span><span class="o">.</span><span class="n">T</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">orderFsm</span> <span class="o">:=</span> <span class="n">newOrderFSM</span><span class="p">()</span>

	<span class="c">// Define the context for order creation.</span>
	<span class="n">creationCtx</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="n">OrderCreationContext</span><span class="p">{</span>
		<span class="n">items</span><span class="o">:</span> <span class="p">[]</span><span class="kt">string</span><span class="p">{},</span>
	<span class="p">}</span>

	<span class="c">// Try to create an order with invalid set of items.</span>
	<span class="n">err</span> <span class="o">:=</span> <span class="n">orderFsm</span><span class="o">.</span><span class="n">SendEvent</span><span class="p">(</span><span class="n">CreateOrder</span><span class="p">,</span> <span class="n">creationCtx</span><span class="p">)</span>
	<span class="k">if</span> <span class="n">err</span> <span class="o">!=</span> <span class="no">nil</span> <span class="p">{</span>
		<span class="n">t</span><span class="o">.</span><span class="n">Errorf</span><span class="p">(</span><span class="s">"Failed to send create order event, err: %v"</span><span class="p">,</span> <span class="n">err</span><span class="p">)</span>
	<span class="p">}</span>

	<span class="c">// The state machine should enter the OrderFailed state.</span>
	<span class="k">if</span> <span class="n">orderFsm</span><span class="o">.</span><span class="n">Current</span> <span class="o">!=</span> <span class="n">OrderFailed</span> <span class="p">{</span>
		<span class="n">t</span><span class="o">.</span><span class="n">Errorf</span><span class="p">(</span><span class="s">"Expected the FSM to be in the OrderFailed state, actual: %s"</span><span class="p">,</span>
			<span class="n">orderFsm</span><span class="o">.</span><span class="n">Current</span><span class="p">)</span>
	<span class="p">}</span>

	<span class="c">// Let's fix the order creation context.</span>
	<span class="n">creationCtx</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">OrderCreationContext</span><span class="p">{</span>
		<span class="n">items</span><span class="o">:</span> <span class="p">[]</span><span class="kt">string</span><span class="p">{</span><span class="s">"foo"</span><span class="p">,</span> <span class="s">"bar"</span><span class="p">},</span>
	<span class="p">}</span>

	<span class="c">// Let's now retry the same order with a valid set of items.</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">orderFsm</span><span class="o">.</span><span class="n">SendEvent</span><span class="p">(</span><span class="n">CreateOrder</span><span class="p">,</span> <span class="n">creationCtx</span><span class="p">)</span>
	<span class="k">if</span> <span class="n">err</span> <span class="o">!=</span> <span class="no">nil</span> <span class="p">{</span>
		<span class="n">t</span><span class="o">.</span><span class="n">Errorf</span><span class="p">(</span><span class="s">"Failed to send create order event, err: %v"</span><span class="p">,</span> <span class="n">err</span><span class="p">)</span>
	<span class="p">}</span>

	<span class="c">// The state machine should enter the OrderPlaced state.</span>
	<span class="k">if</span> <span class="n">orderFsm</span><span class="o">.</span><span class="n">Current</span> <span class="o">!=</span> <span class="n">OrderPlaced</span> <span class="p">{</span>
		<span class="n">t</span><span class="o">.</span><span class="n">Errorf</span><span class="p">(</span><span class="s">"Expected the FSM to be in the OrderPlaced state, actual: %s"</span><span class="p">,</span>
			<span class="n">orderFsm</span><span class="o">.</span><span class="n">Current</span><span class="p">)</span>
	<span class="p">}</span>

	<span class="c">// Let's now define the context for shipping the order.</span>
	<span class="n">shipmentCtx</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="n">OrderShipmentContext</span><span class="p">{</span>
		<span class="n">cardNumber</span><span class="o">:</span> <span class="s">""</span><span class="p">,</span>
		<span class="n">address</span><span class="o">:</span>    <span class="s">"123 Foo Street, Bar Baz, QU 45678, USA"</span><span class="p">,</span>
	<span class="p">}</span>

	<span class="c">// Try to charge the card using an invalid card number.</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">orderFsm</span><span class="o">.</span><span class="n">SendEvent</span><span class="p">(</span><span class="n">ChargeCard</span><span class="p">,</span> <span class="n">shipmentCtx</span><span class="p">)</span>
	<span class="k">if</span> <span class="n">err</span> <span class="o">!=</span> <span class="no">nil</span> <span class="p">{</span>
		<span class="n">t</span><span class="o">.</span><span class="n">Errorf</span><span class="p">(</span><span class="s">"Failed to send charge card event, err: %v"</span><span class="p">,</span> <span class="n">err</span><span class="p">)</span>
	<span class="p">}</span>

	<span class="c">// The state machine should enter the TransactionFailed state.</span>
	<span class="k">if</span> <span class="n">orderFsm</span><span class="o">.</span><span class="n">Current</span> <span class="o">!=</span> <span class="n">TransactionFailed</span> <span class="p">{</span>
		<span class="n">t</span><span class="o">.</span><span class="n">Errorf</span><span class="p">(</span><span class="s">"Expected the FSM to be in the TransactionFailed state, actual: %s"</span><span class="p">,</span>
			<span class="n">orderFsm</span><span class="o">.</span><span class="n">Current</span><span class="p">)</span>
	<span class="p">}</span>

	<span class="c">// Let's fix the shipment context.</span>
	<span class="n">shipmentCtx</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">OrderShipmentContext</span><span class="p">{</span>
		<span class="n">cardNumber</span><span class="o">:</span> <span class="s">"0000-0000-0000-0000"</span><span class="p">,</span>
		<span class="n">address</span><span class="o">:</span>    <span class="s">"123 Foo Street, Bar Baz, QU 45678, USA"</span><span class="p">,</span>
	<span class="p">}</span>

	<span class="c">// Let's now retry the transaction with a valid card number.</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">orderFsm</span><span class="o">.</span><span class="n">SendEvent</span><span class="p">(</span><span class="n">ChargeCard</span><span class="p">,</span> <span class="n">shipmentCtx</span><span class="p">)</span>
	<span class="k">if</span> <span class="n">err</span> <span class="o">!=</span> <span class="no">nil</span> <span class="p">{</span>
		<span class="n">t</span><span class="o">.</span><span class="n">Errorf</span><span class="p">(</span><span class="s">"Failed to send charge card event, err: %v"</span><span class="p">,</span> <span class="n">err</span><span class="p">)</span>
	<span class="p">}</span>

	<span class="c">// The state machine should enter the OrderShipped state.</span>
	<span class="k">if</span> <span class="n">orderFsm</span><span class="o">.</span><span class="n">Current</span> <span class="o">!=</span> <span class="n">OrderShipped</span> <span class="p">{</span>
		<span class="n">t</span><span class="o">.</span><span class="n">Errorf</span><span class="p">(</span><span class="s">"Expected the FSM to be in the OrderShipped state, actual: %s"</span><span class="p">,</span>
			<span class="n">orderFsm</span><span class="o">.</span><span class="n">Current</span><span class="p">)</span>
	<span class="p">}</span>

	<span class="c">// Let's try charging the card again for the same order. We should see the</span>
	<span class="c">// event getting rejected as the card has been already charged once and the</span>
	<span class="c">// state machine is in the OrderShipped state.</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">orderFsm</span><span class="o">.</span><span class="n">SendEvent</span><span class="p">(</span><span class="n">ChargeCard</span><span class="p">,</span> <span class="n">shipmentCtx</span><span class="p">)</span>
	<span class="k">if</span> <span class="n">err</span> <span class="o">!=</span> <span class="n">ErrEventRejected</span> <span class="p">{</span>
		<span class="n">t</span><span class="o">.</span><span class="n">Errorf</span><span class="p">(</span><span class="s">"Expected the FSM to return a rejected event error"</span><span class="p">)</span>
	<span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Here’s the output from running the test.</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">===</span> RUN   TestOrderFSM
Validating, order: OrderCreationContext <span class="o">[</span> items: , err: &lt;nil&gt; <span class="o">]</span>
Order failed, err: Insufficient number of items <span class="k">in </span>order
Validating, order: OrderCreationContext <span class="o">[</span> items: foo,bar, err: &lt;nil&gt; <span class="o">]</span>
Order placed, items: <span class="o">[</span>foo bar]
Validating card, shipment: OrderShipmentContext <span class="o">[</span> cardNumber: , address: 123 Foo Street, Bar Baz, QU 45678, USA, err: &lt;nil&gt; <span class="o">]</span>
Transaction failed, err: Card number is invalid
Validating card, shipment: OrderShipmentContext <span class="o">[</span> cardNumber: 0000-0000-0000-0000, address: 123 Foo Street, Bar Baz, QU 45678, USA, err: &lt;nil&gt; <span class="o">]</span>
Order shipped, address: 123 Foo Street, Bar Baz, QU 45678, USA
<span class="nt">---</span> PASS: TestOrderFSM <span class="o">(</span>0.00s<span class="o">)</span>
</code></pre></div></div>

<p>This implementation passes in appropriate contexts (i.e. <code class="language-plaintext highlighter-rouge">OrderCreationContext</code> and
<code class="language-plaintext highlighter-rouge">OrderShipmentContext</code>) along with the event during the call to <code class="language-plaintext highlighter-rouge">SendEvent</code>. Note that the event
actions called as a part of the loop for a single event all get the same context and can reuse
fields (for example, see the usage of the <code class="language-plaintext highlighter-rouge">items</code> field in both <code class="language-plaintext highlighter-rouge">CreatingOrderAction</code> and the
<code class="language-plaintext highlighter-rouge">OrderPlacedAction</code>). One key situation that was very easily handled by the framework is a duplicate
call for charging the card (see the last part of the test above). Since the state machine had
already transitioned over to the <code class="language-plaintext highlighter-rouge">OrderShipped</code> state, the <code class="language-plaintext highlighter-rouge">ChargeCard</code> event was rejected straight
away and we prevented the system from getting into an inconsistent state just by the help of the
declarative state machine configuration.</p>

<h2 id="conclusion">Conclusion</h2>

<p>State machines are a powerful concept which can bring order into systems with asynchronous and
multi-source inputs. As shown in the examples in this post, state machines are capable of producing
deterministic behavior in complex situations, and the state machine framework described in this post
can nicely handle simple use-cases that you may come across in everyday life.</p>

<hr />

<p>I’d love to hear your feedback!</p>

<p><strong>Disclaimer:</strong> My postings are my own and don’t necessarily represent VMware’s positions, strategies or opinions.</p>

                </div>
            </section>

            <!-- Email subscribe form at the bottom of the page -->
            

            <footer class="post-full-footer">
                <!-- Everything inside the #author tags pulls data from the author -->
                <!-- #author-->
                
                    
                        <section class="author-card">
                            
                                <img class="author-profile-image" src="/assets/images/venilnoronha.png" alt="venilnoronha" />
                            
                            <section class="author-card-content">
                                <h4 class="author-card-name">
                                    
                                        <a href="/about/">Venil Noronha</a>
                                    
                                </h4>
                                
                                    <p>Open Source Enthusiast</p>
                                
                                <p style="margin-top: 2px;">
                                    <a href="https://github.com/venilnoronha" target="_blank" rel="noopener">GitHub</a> |
                                    
                                    <a href="https://twitter.com/venilnoronha" target="_blank" rel="noopener">Twitter</a> |
                                    
                                    <a href="https://linkedin.com/in/venilnoronha" target="_blank" rel="noopener">LinkedIn</a>
                                </p>
                            </section>
                        </section>
                        <div class="post-full-footer-right">
                            <a class="author-card-button" href="/author/venilnoronha">Read More</a>
                        </div>
                    
                
                <!-- /author  -->
            </footer>

            <!-- If you use Disqus comments, just uncomment this block.
            The only thing you need to change is "test-apkdzgmqhj" - which
            should be replaced with your own Disqus site-id. -->
            
                <section class="post-full-comments">
                    <div id="disqus_thread"></div>
                    <script>
                        var disqus_config = function () {
                            this.page.url = 'https://venilnoronha.io/a-simple-state-machine-framework-in-go';
                            this.page.identifier = 'A Simple State Machine Framework in Go';
                        };
                        (function() {
                            var d = document, s = d.createElement('script');
                            s.src = 'https://venilnoronha-io.disqus.com/embed.js';
                            s.setAttribute('data-timestamp', +new Date());
                            (d.head || d.body).appendChild(s);
                        })();
                    </script>
                </section>
            

        </article>

    </div>
</main>

<!-- Links to Previous/Next posts -->
<aside class="read-next outer">
    <div class="inner">
        <div class="read-next-feed">
            
                
                
                
                
                    <article class="read-next-card"
                        
                            style="background-image: url(/assets/images/blog-cover.jpg)"
                        
                    >
                        <header class="read-next-card-header">
                            <small class="read-next-card-header-sitetitle">&mdash; Venil Noronha &mdash;</small>
                            
                                <h3 class="read-next-card-header-title"><a href="/tag/distributed-systems/">Distributed systems</a></h3>
                            
                        </header>
                        <div class="read-next-divider"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 14.5s2 3 5 3 5.5-2.463 5.5-5.5S21 6.5 18 6.5c-5 0-7 11-12 11C2.962 17.5.5 15.037.5 12S3 6.5 6 6.5s4.5 3.5 4.5 3.5"/></svg>
</div>
                        <div class="read-next-card-content">
                            <ul>
                                
                                
                                  
                                    
                                        
                                        
                                            <li><a href="/introduction-to-original-destination-in-envoy">Introduction to Original Destination in Envoy</a></li>
                                        
                                    
                                  
                                
                                  
                                    
                                        
                                        
                                            <li><a href="/a-beginners-guide-to-authn-and-authz-with-istio">A Beginner's Guide to AuthN and AuthZ with Istio</a></li>
                                        
                                    
                                  
                                
                                  
                                    
                                  
                                
                                  
                                    
                                        
                                        
                                            <li><a href="/how-to-write-envoy-filters-like-a-ninja">How to Write Envoy Filters Like a Ninja!</a></li>
                                        
                                    
                                  
                                
                                  
                                    
                                        
                                        
                                    
                                  
                                
                                  
                                    
                                        
                                        
                                    
                                  
                                
                                  
                                    
                                        
                                        
                                    
                                  
                                
                                  
                                    
                                        
                                        
                                    
                                  
                                
                                  
                                    
                                        
                                        
                                    
                                  
                                
                                  
                                    
                                        
                                        
                                    
                                  
                                
                                  
                                    
                                        
                                        
                                    
                                  
                                
                                  
                                    
                                        
                                        
                                    
                                  
                                
                                  
                                    
                                        
                                        
                                    
                                  
                                
                            </ul>
                        </div>
                        <footer class="read-next-card-footer">
                            <a href="/tag/distributed-systems/">
                                
                                    See all 13 posts  →
                                
                            </a>
                        </footer>
                    </article>
                
            

            <!-- If there's a next post, display it using the same markup included from - partials/post-card.hbs -->
            
                
    <article class="post-card post-template">
        
            <a class="post-card-image-link" href="/a-beginners-guide-to-authn-and-authz-with-istio">
                <div class="post-card-image" style="background-image: url(/assets/images/2021-03-02-a-beginners-guide-to-authn-and-authz-with-istio/banner.jpg)"></div>
            </a>
        
        <div class="post-card-content">
            <a class="post-card-content-link" href="/a-beginners-guide-to-authn-and-authz-with-istio">
                <header class="post-card-header">
                    
                        
                            
                                <span class="post-card-tags">Distributed systems</span>
                            
                        
                    

                    <h2 class="post-card-title">A Beginner's Guide to AuthN and AuthZ with Istio</h2>
                </header>
                <section class="post-card-excerpt">
                    <p>Service meshes solve some of the key challenges in the cloud-native world today, and in this post I'll be discussing about security. The [Istio][istio] service mesh provides several security features including identity assignment</p>
                </section>
            </a>
            <footer class="post-card-meta">
                
                    
                        
                        <img class="author-profile-image" src="/assets/images/venilnoronha.png" alt="Venil Noronha" />
                        
                        <span class="post-card-author">
                            
                                <a href="/about/">Venil Noronha</a>
                            
                        </span>
                    
                
            </footer>
        </div>
    </article>

            

            <!-- If there's a previous post, display it using the same markup included from - partials/post-card.hbs -->
            
                
    <article class="post-card post-template">
        
            <a class="post-card-image-link" href="/how-to-write-envoy-filters-like-a-ninja">
                <div class="post-card-image" style="background-image: url(/assets/images/2019-05-28-how-to-write-envoy-filters-like-a-ninja/banner.jpg)"></div>
            </a>
        
        <div class="post-card-content">
            <a class="post-card-content-link" href="/how-to-write-envoy-filters-like-a-ninja">
                <header class="post-card-header">
                    
                        
                            
                                <span class="post-card-tags">Distributed systems</span>
                            
                        
                    

                    <h2 class="post-card-title">How to Write Envoy Filters Like a Ninja!</h2>
                </header>
                <section class="post-card-excerpt">
                    <p>Envoy is a programmable L3/L4 and L7 proxy that powers today’s service mesh solutions including Istio, AWS App Mesh, Consul Connect, etc. At Envoy’s core lie several filters that provide a rich set</p>
                </section>
            </a>
            <footer class="post-card-meta">
                
                    
                        
                        <img class="author-profile-image" src="/assets/images/venilnoronha.png" alt="Venil Noronha" />
                        
                        <span class="post-card-author">
                            
                                <a href="/about/">Venil Noronha</a>
                            
                        </span>
                    
                
            </footer>
        </div>
    </article>

            

        </div>
    </div>
</aside>

<!-- Floating header which appears on-scroll, included from includes/floating-header.hbs -->
<div class="floating-header">
    <div class="floating-header-logo">
        <a href="https://venilnoronha.io/">
            
                <img src="/assets/images/favicon.png" alt="Venil Noronha icon" />
            
            <span>Venil Noronha</span>
        </a>
    </div>
    <span class="floating-header-divider">&mdash;</span>
    <div class="floating-header-title">A Simple State Machine Framework in Go</div>
    <div class="floating-header-share">
        <div class="floating-header-share-label">Share this <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
    <path d="M7.5 15.5V4a1.5 1.5 0 1 1 3 0v4.5h2a1 1 0 0 1 1 1h2a1 1 0 0 1 1 1H18a1.5 1.5 0 0 1 1.5 1.5v3.099c0 .929-.13 1.854-.385 2.748L17.5 23.5h-9c-1.5-2-5.417-8.673-5.417-8.673a1.2 1.2 0 0 1 1.76-1.605L7.5 15.5zm6-6v2m-3-3.5v3.5m6-1v2"/>
</svg>
</div>
        <a class="floating-header-share-tw" href="https://twitter.com/share?text=A+Simple+State+Machine+Framework+in+Go&amp;url=https://venilnoronha.io/a-simple-state-machine-framework-in-go"
            onclick="window.open(this.href, 'share-twitter', 'width=550,height=235');return false;">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 32 32"><path d="M30.063 7.313c-.813 1.125-1.75 2.125-2.875 2.938v.75c0 1.563-.188 3.125-.688 4.625a15.088 15.088 0 0 1-2.063 4.438c-.875 1.438-2 2.688-3.25 3.813a15.015 15.015 0 0 1-4.625 2.563c-1.813.688-3.75 1-5.75 1-3.25 0-6.188-.875-8.875-2.625.438.063.875.125 1.375.125 2.688 0 5.063-.875 7.188-2.5-1.25 0-2.375-.375-3.375-1.125s-1.688-1.688-2.063-2.875c.438.063.813.125 1.125.125.5 0 1-.063 1.5-.25-1.313-.25-2.438-.938-3.313-1.938a5.673 5.673 0 0 1-1.313-3.688v-.063c.813.438 1.688.688 2.625.688a5.228 5.228 0 0 1-1.875-2c-.5-.875-.688-1.813-.688-2.75 0-1.063.25-2.063.75-2.938 1.438 1.75 3.188 3.188 5.25 4.25s4.313 1.688 6.688 1.813a5.579 5.579 0 0 1 1.5-5.438c1.125-1.125 2.5-1.688 4.125-1.688s3.063.625 4.188 1.813a11.48 11.48 0 0 0 3.688-1.375c-.438 1.375-1.313 2.438-2.563 3.188 1.125-.125 2.188-.438 3.313-.875z"/></svg>

        </a>
        <a class="floating-header-share-fb" href="https://www.facebook.com/sharer/sharer.php?u=https://venilnoronha.io/a-simple-state-machine-framework-in-go"
            onclick="window.open(this.href, 'share-facebook','width=580,height=296');return false;">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 32 32"><path d="M19 6h5V0h-5c-3.86 0-7 3.14-7 7v3H8v6h4v16h6V16h5l1-6h-6V7c0-.542.458-1 1-1z"/></svg>

        </a>
    </div>
    <progress class="progress" value="0">
        <div class="progress-container">
            <span class="progress-bar"></span>
        </div>
    </progress>
</div>


<!-- /post -->

<!-- The #contentFor helper here will send everything inside it up to the matching #block helper found in default.hbs -->


        <!-- Previous/next page links - displayed on every page -->
        

        <!-- The footer at the very bottom of the screen -->
        <footer class="site-footer outer">
            <div class="site-footer-content inner">
                <section class="copyright"><a href="https://venilnoronha.io/">Venil Noronha</a> &copy; 2022</section>
                <section class="poweredby">Proudly published with <a href="https://jekyllrb.com/">Jekyll</a> &
                    <a href="https://pages.github.com/" target="_blank" rel="noopener">GitHub Pages</a> using
                    <a href="https://github.com/jekyller/jasper2" target="_blank" rel="noopener">Jasper2</a></section>
                <nav class="site-footer-nav">
                    <a href="https://github.com/venilnoronha" target="_blank" rel="noopener">GitHub</a>
                    
                    <a href="https://twitter.com/venilnoronha" target="_blank" rel="noopener">Twitter</a>
                    
                    <a href="https://linkedin.com/in/venilnoronha" target="_blank" rel="noopener">LinkedIn</a>
                </nav>
            </div>
        </footer>

    </div>

    <!-- The big email subscribe modal content -->
    

    <!-- highlight.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.10.0/components/prism-abap.min.js"></script>
    <script>$(document).ready(function() {
      $('pre code').each(function(i, block) {
        hljs.highlightBlock(block);
      });
    });</script>

    <!-- jQuery + Fitvids, which makes all video embeds responsive -->
    <script
        src="https://code.jquery.com/jquery-3.2.1.min.js"
        integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4="
        crossorigin="anonymous">
    </script>
    <script type="text/javascript" src="/assets/js/jquery.fitvids.js"></script>
    <script type="text/javascript" src="https://demo.ghost.io/assets/js/jquery.fitvids.js?v=724281a32e"></script>


    <!-- Paginator increased to "infinit" in _config.yml -->
    <!-- if paginator.posts  -->
    <!-- <script>
        var maxPages = parseInt('');
    </script>
    <script src="/assets/js/infinitescroll.js"></script> -->
    <!-- /endif -->

    


    <!-- Add Google Analytics  -->
     <!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-PP90X6NKJH"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-PP90X6NKJH');
</script>


    <!-- The #block helper will pull in data from the #contentFor other template files. In this case, there's some JavaScript which we only want to use in post.hbs, but it needs to be included down here, after jQuery has already loaded. -->
    
        <script>

// NOTE: Scroll performance is poor in Safari
// - this appears to be due to the events firing much more slowly in Safari.
//   Dropping the scroll event and using only a raf loop results in smoother
//   scrolling but continuous processing even when not scrolling
$(document).ready(function () {
    // Start fitVids
    var $postContent = $(".post-full-content");
    $postContent.fitVids();
    // End fitVids

    var progressBar = document.querySelector('progress');
    var header = document.querySelector('.floating-header');
    var title = document.querySelector('.post-full-title');

    var lastScrollY = window.scrollY;
    var lastWindowHeight = window.innerHeight;
    var lastDocumentHeight = $(document).height();
    var ticking = false;

    function onScroll() {
        lastScrollY = window.scrollY;
        requestTick();
    }

    function onResize() {
        lastWindowHeight = window.innerHeight;
        lastDocumentHeight = $(document).height();
        requestTick();
    }

    function requestTick() {
        if (!ticking) {
            requestAnimationFrame(update);
        }
        ticking = true;
    }

    function update() {
        var trigger = title.getBoundingClientRect().top + window.scrollY;
        var triggerOffset = title.offsetHeight + 35;
        var progressMax = lastDocumentHeight - lastWindowHeight;

        // show/hide floating header
        if (lastScrollY >= trigger + triggerOffset) {
            header.classList.add('floating-active');
        } else {
            header.classList.remove('floating-active');
        }

        progressBar.setAttribute('max', progressMax);
        progressBar.setAttribute('value', lastScrollY);

        ticking = false;
    }

    window.addEventListener('scroll', onScroll, {passive: true});
    window.addEventListener('resize', onResize, false);

    update();
});
</script>

    

    <!-- Ghost outputs important scripts and data with this tag - it should always be the very last thing before the closing body tag -->
    <!-- ghost_foot -->

</body>
</html>
