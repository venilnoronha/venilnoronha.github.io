<!DOCTYPE html>
<html>
<head>

    <!-- Document Settings -->
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />

    <!-- Base Meta -->
    <!-- dynamically fixing the title for tag/author pages -->



    <title>Raw TCP Traffic Shaping with Istio 1.1.0</title>
    <meta name="HandheldFriendly" content="True" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <!-- Styles'n'Scripts -->
    <link rel="stylesheet" type="text/css" href="/assets/built/screen.css" />
    <link rel="stylesheet" type="text/css" href="/assets/built/screen.edited.css" />
    <link rel="stylesheet" type="text/css" href="/assets/built/syntax.css" />
    <!-- highlight.js -->
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/default.min.css">
    <style>.hljs { background: none; }</style>

    <!-- This tag outputs SEO meta+structured data and other important settings -->
    <meta name="description" content="Distributed systems, software design, and more..." />
    <link rel="shortcut icon" href="https://venilnoronha.io/assets/images/favicon.png" type="image/png" />
    <link rel="canonical" href="https://venilnoronha.io/raw-tcp-traffic-shaping-with-istio-1.1.0" />
    <meta name="referrer" content="no-referrer-when-downgrade" />

     <!--title below is coming from _includes/dynamic_title-->
    <meta property="og:site_name" content="Venil Noronha" />
    <meta property="og:type" content="website" />
    <meta property="og:title" content="Raw TCP Traffic Shaping with Istio 1.1.0" />
    <meta property="og:description" content="Istio provides sophisticated routing mechanics via concepts like VirtualService, DestinationRule, Gateway, etc. Istio 1.0 enabled HTTP traffic shifting via weighted route definitions. I was able to contribute a similar feature for TCP/TLS services via my PRs on Envoy and on Istio. The feature in Envoy was released in 1.8.0 and" />
    <meta property="og:url" content="https://venilnoronha.io/raw-tcp-traffic-shaping-with-istio-1.1.0" />
    <meta property="og:image" content="https://venilnoronha.io/assets/images/2018-10-19-raw-tcp-traffic-shaping-with-istio-1.1.0/banner.jpg" />
    <meta property="article:publisher" content="https://www.facebook.com/false" />
    <meta property="article:author" content="https://www.facebook.com/false" />
    <meta property="article:published_time" content="2018-10-19T06:00:00-07:00" />
    <meta property="article:modified_time" content="2018-10-19T06:00:00-07:00" />
    <meta property="article:tag" content="Distributed Systems" />
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content="Raw TCP Traffic Shaping with Istio 1.1.0" />
    <meta name="twitter:description" content="Istio provides sophisticated routing mechanics via concepts like VirtualService, DestinationRule, Gateway, etc. Istio 1.0 enabled HTTP traffic shifting via weighted route definitions. I was able to contribute a similar feature for TCP/TLS services via my PRs on Envoy and on Istio. The feature in Envoy was released in 1.8.0 and" />
    <meta name="twitter:url" content="https://venilnoronha.io/" />
    <meta name="twitter:image" content="https://venilnoronha.io/assets/images/2018-10-19-raw-tcp-traffic-shaping-with-istio-1.1.0/banner.jpg" />
    <meta name="twitter:label1" content="Written by" />
    <meta name="twitter:data1" content="Venil Noronha" />
    <meta name="twitter:label2" content="Filed under" />
    <meta name="twitter:data2" content="Distributed Systems" />
    <meta name="twitter:site" content="@venilnoronha" />
    <meta name="twitter:creator" content="@venilnoronha" />
    <meta property="og:image:width" content="1400" />
    <meta property="og:image:height" content="933" />

    <script type="application/ld+json">
{
    "@context": "https://schema.org",
    "@type": "Website",
    "publisher": {
        "@type": "Organization",
        "name": "Venil Noronha",
        "logo": "https://venilnoronha.io/false"
    },
    "url": "https://venilnoronha.io/raw-tcp-traffic-shaping-with-istio-1.1.0",
    "image": {
        "@type": "ImageObject",
        "url": "https://venilnoronha.io/assets/images/2018-10-19-raw-tcp-traffic-shaping-with-istio-1.1.0/banner.jpg",
        "width": 2000,
        "height": 666
    },
    "mainEntityOfPage": {
        "@type": "WebPage",
        "@id": "https://venilnoronha.io/raw-tcp-traffic-shaping-with-istio-1.1.0"
    },
    "description": "Istio provides sophisticated routing mechanics via concepts like VirtualService, DestinationRule, Gateway, etc. Istio 1.0 enabled HTTP traffic shifting via weighted route definitions. I was able to contribute a similar feature for TCP/TLS services via my PRs on Envoy and on Istio. The feature in Envoy was released in 1.8.0 and"
}
    </script>

    <!-- <script type="text/javascript" src="https://demo.ghost.io/public/ghost-sdk.min.js?v=724281a32e"></script>
    <script type="text/javascript">
    ghost.init({
    	clientId: "ghost-frontend",
    	clientSecret: "f84a07a72b17"
    });
    </script> -->

    <meta name="generator" content="Jekyll 3.6.2" />
    <link rel="alternate" type="application/rss+xml" title="Raw TCP Traffic Shaping with Istio 1.1.0" href="/feed.xml" />


</head>
<body class="post-template">

    <div class="site-wrapper">
        <!-- All the main content gets inserted here, index.hbs, post.hbs, etc -->
        <!-- default -->

<!-- The tag above means: insert everything in this file
into the {body} of the default.hbs template -->

<header class="site-header outer">
    <div class="inner">
        <nav class="site-nav">
    <div class="site-nav-left">
        
            
                <a class="site-nav-logo" href="https://venilnoronha.io/">Venil Noronha</a>
            
        
        
            <ul class="nav" role="menu">
    <li class="nav-home" role="menuitem"><a href="/">Home</a></li>
    <li class="nav-about" role="menuitem"><a href="/about/">About</a></li>
    <li class="nav-feed" role="menuitem"><a href="https://venilnoronha.io/feed.xml">Feed</a></li>
</ul>

        
    </div>
    <div class="site-nav-right">
        <div class="social-links">
            
                <a class="social-link" href="https://github.com/venilnoronha" target="_blank" rel="noopener"><svg viewBox="0 0 1792 1792" xmlns="http://www.w3.org/2000/svg"><path d="M896 128q209 0 385.5 103t279.5 279.5 103 385.5q0 251-146.5 451.5t-378.5 277.5q-27 5-40-7t-13-30q0-3 .5-76.5t.5-134.5q0-97-52-142 57-6 102.5-18t94-39 81-66.5 53-105 20.5-150.5q0-119-79-206 37-91-8-204-28-9-81 11t-92 44l-38 24q-93-26-192-26t-192 26q-16-11-42.5-27t-83.5-38.5-85-13.5q-45 113-8 204-79 87-79 206 0 85 20.5 150t52.5 105 80.5 67 94 39 102.5 18q-39 36-49 103-21 10-45 15t-57 5-65.5-21.5-55.5-62.5q-19-32-48.5-52t-49.5-24l-20-3q-21 0-29 4.5t-5 11.5 9 14 13 12l7 5q22 10 43.5 38t31.5 51l10 23q13 38 44 61.5t67 30 69.5 7 55.5-3.5l23-4q0 38 .5 88.5t.5 54.5q0 18-13 30t-40 7q-232-77-378.5-277.5t-146.5-451.5q0-209 103-385.5t279.5-279.5 385.5-103zm-477 1103q3-7-7-12-10-3-13 2-3 7 7 12 9 6 13-2zm31 34q7-5-2-16-10-9-16-3-7 5 2 16 10 10 16 3zm30 45q9-7 0-19-8-13-17-6-9 5 0 18t17 7zm42 42q8-8-4-19-12-12-20-3-9 8 4 19 12 12 20 3zm57 25q3-11-13-16-15-4-19 7t13 15q15 6 19-6zm63 5q0-13-17-11-16 0-16 11 0 13 17 11 16 0 16-11zm58-10q-2-11-18-9-16 3-14 15t18 8 14-14z"/></svg>
</a>
            
            
            
                <a class="social-link social-link-tw" href="https://twitter.com/venilnoronha" target="_blank" rel="noopener"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 32 32"><path d="M30.063 7.313c-.813 1.125-1.75 2.125-2.875 2.938v.75c0 1.563-.188 3.125-.688 4.625a15.088 15.088 0 0 1-2.063 4.438c-.875 1.438-2 2.688-3.25 3.813a15.015 15.015 0 0 1-4.625 2.563c-1.813.688-3.75 1-5.75 1-3.25 0-6.188-.875-8.875-2.625.438.063.875.125 1.375.125 2.688 0 5.063-.875 7.188-2.5-1.25 0-2.375-.375-3.375-1.125s-1.688-1.688-2.063-2.875c.438.063.813.125 1.125.125.5 0 1-.063 1.5-.25-1.313-.25-2.438-.938-3.313-1.938a5.673 5.673 0 0 1-1.313-3.688v-.063c.813.438 1.688.688 2.625.688a5.228 5.228 0 0 1-1.875-2c-.5-.875-.688-1.813-.688-2.75 0-1.063.25-2.063.75-2.938 1.438 1.75 3.188 3.188 5.25 4.25s4.313 1.688 6.688 1.813a5.579 5.579 0 0 1 1.5-5.438c1.125-1.125 2.5-1.688 4.125-1.688s3.063.625 4.188 1.813a11.48 11.48 0 0 0 3.688-1.375c-.438 1.375-1.313 2.438-2.563 3.188 1.125-.125 2.188-.438 3.313-.875z"/></svg>
</a>
            
            
                <a class="social-link" href="https://instagram.com/venilnoronha" target="_blank" rel="noopener"><svg viewBox="0 0 1792 1792" xmlns="http://www.w3.org/2000/svg"><path d="M1152 896q0-106-75-181t-181-75-181 75-75 181 75 181 181 75 181-75 75-181zm138 0q0 164-115 279t-279 115-279-115-115-279 115-279 279-115 279 115 115 279zm108-410q0 38-27 65t-65 27-65-27-27-65 27-65 65-27 65 27 27 65zm-502-220q-7 0-76.5-.5t-105.5 0-96.5 3-103 10-71.5 18.5q-50 20-88 58t-58 88q-11 29-18.5 71.5t-10 103-3 96.5 0 105.5.5 76.5-.5 76.5 0 105.5 3 96.5 10 103 18.5 71.5q20 50 58 88t88 58q29 11 71.5 18.5t103 10 96.5 3 105.5 0 76.5-.5 76.5.5 105.5 0 96.5-3 103-10 71.5-18.5q50-20 88-58t58-88q11-29 18.5-71.5t10-103 3-96.5 0-105.5-.5-76.5.5-76.5 0-105.5-3-96.5-10-103-18.5-71.5q-20-50-58-88t-88-58q-29-11-71.5-18.5t-103-10-96.5-3-105.5 0-76.5.5zm768 630q0 229-5 317-10 208-124 322t-322 124q-88 5-317 5t-317-5q-208-10-322-124t-124-322q-5-88-5-317t5-317q10-208 124-322t322-124q88-5 317-5t317 5q208 10 322 124t124 322q5 88 5 317z"/></svg>
</a>
            
            
                <a class="social-link" href="https://linkedin.com/in/venilnoronha" target="_blank" rel="noopener"><svg viewBox="0 0 1792 1792" xmlns="http://www.w3.org/2000/svg"><path d="M365 1414h231v-694h-231v694zm246-908q-1-52-36-86t-93-34-94.5 34-36.5 86q0 51 35.5 85.5t92.5 34.5h1q59 0 95-34.5t36-85.5zm585 908h231v-398q0-154-73-233t-193-79q-136 0-209 117h2v-101h-231q3 66 0 694h231v-388q0-38 7-56 15-35 45-59.5t74-24.5q116 0 116 157v371zm468-998v960q0 119-84.5 203.5t-203.5 84.5h-960q-119 0-203.5-84.5t-84.5-203.5v-960q0-119 84.5-203.5t203.5-84.5h960q119 0 203.5 84.5t84.5 203.5z"/></svg>
</a>
            
        </div>
        
    </div>
</nav>

    </div>
</header>

<!-- Everything inside the #post tags pulls data from the post -->
<!-- #post -->

<main id="site-main" class="site-main outer" role="main">
    <div class="inner">

        <article class="post-full post tag-distributed-systems ">

            <header class="post-full-header">
                <section class="post-full-meta">
                    <time class="post-full-meta-date" datetime="19 October 2018">19 October 2018</time>
                    
                        <span class="date-divider">/</span>
                        
                            
                               <a href='/tag/distributed-systems/'>DISTRIBUTED SYSTEMS</a>
                            
                        
                    
                </section>
                <h1 class="post-full-title">Raw TCP Traffic Shaping with Istio 1.1.0</h1>
            </header>

            
            <figure class="post-full-image" style="background-image: url(/assets/images/2018-10-19-raw-tcp-traffic-shaping-with-istio-1.1.0/banner.jpg)">
            </figure>
            

            <section class="post-full-content">
                <div class="kg-card-markdown">
                    <p><a href="https://istio.io/">Istio</a> provides sophisticated routing mechanics via concepts
like <a href="https://istio.io/docs/reference/config/istio.networking.v1alpha3/#VirtualService">VirtualService</a>,
<a href="https://istio.io/docs/reference/config/istio.networking.v1alpha3/#DestinationRule">DestinationRule</a>,
<a href="https://istio.io/docs/reference/config/istio.networking.v1alpha3/#Gateway">Gateway</a>,
etc. Istio 1.0 enabled HTTP traffic shifting via <a href="https://istio.io/docs/tasks/traffic-management/traffic-shifting/#apply-weight-based-routing">weighted route definitions</a>.
I was able to contribute a similar feature for TCP/TLS services via my PRs
<a href="https://github.com/envoyproxy/envoy/pull/4430">on Envoy</a> and <a href="https://github.com/istio/istio/pull/9112">on Istio</a>.
The feature in Envoy was released in <a href="https://www.envoyproxy.io/docs/envoy/latest/intro/version_history#oct-4-2018">1.8.0</a>
and the one in Istio will be available in the upcoming <a href="https://github.com/istio/istio/releases/">1.1.0</a>
release.</p>

<p><img src="assets/images/2018-10-19-raw-tcp-traffic-shaping-with-istio-1.1.0/istio-logo.svg" alt="Istio" style="width: 150px;" /></p>

<p>In this article, we’ll be looking at a simple TCP Echo Server written in <a href="https://golang.org/">Go</a>,
containerize it with <a href="https://www.docker.com/">Docker</a>, deploy it over
<a href="https://kubernetes.io/">Kubernetes</a>, and exercise Istio’s weighted TCP routing
feature over it to understand its behavior in production services.</p>

<h2 id="the-tcp-echo-server">The TCP Echo Server</h2>

<p>For the purpose of this post, we’ll be creating a simple TCP Server which
listens to connections and prepends a simple prefix to the Client request data
and returns it as a response. Below is a pictorial representation of the same.</p>

<p><img src="assets/images/2018-10-19-raw-tcp-traffic-shaping-with-istio-1.1.0/tcp-client-server.svg" alt="TCP Client - Server Architecture" /></p>

<p>Let’s now look at the Go code for the TCP Echo Server.</p>

<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">package</span><span class="x"> </span><span class="n">main</span><span class="x">

</span><span class="k">import</span><span class="x"> </span><span class="p">(</span><span class="x">
	</span><span class="s">"bufio"</span><span class="x">
	</span><span class="s">"fmt"</span><span class="x">
	</span><span class="s">"io"</span><span class="x">
	</span><span class="s">"net"</span><span class="x">
	</span><span class="s">"os"</span><span class="x">
</span><span class="p">)</span><span class="x">

</span><span class="c">// main serves as the program entry point</span><span class="x">
</span><span class="k">func</span><span class="x"> </span><span class="n">main</span><span class="p">()</span><span class="x"> </span><span class="p">{</span><span class="x">
	</span><span class="c">// obtain the port and prefix via program arguments</span><span class="x">
	</span><span class="n">port</span><span class="x"> </span><span class="o">:=</span><span class="x"> </span><span class="n">fmt</span><span class="o">.</span><span class="n">Sprintf</span><span class="p">(</span><span class="s">":%s"</span><span class="p">,</span><span class="x"> </span><span class="n">os</span><span class="o">.</span><span class="n">Args</span><span class="p">[</span><span class="m">1</span><span class="p">])</span><span class="x">
	</span><span class="n">prefix</span><span class="x"> </span><span class="o">:=</span><span class="x"> </span><span class="n">os</span><span class="o">.</span><span class="n">Args</span><span class="p">[</span><span class="m">2</span><span class="p">]</span><span class="x">

	</span><span class="c">// create a tcp listener on the given port</span><span class="x">
	</span><span class="n">listener</span><span class="p">,</span><span class="x"> </span><span class="n">err</span><span class="x"> </span><span class="o">:=</span><span class="x"> </span><span class="n">net</span><span class="o">.</span><span class="n">Listen</span><span class="p">(</span><span class="s">"tcp"</span><span class="p">,</span><span class="x"> </span><span class="n">port</span><span class="p">)</span><span class="x">
	</span><span class="k">if</span><span class="x"> </span><span class="n">err</span><span class="x"> </span><span class="o">!=</span><span class="x"> </span><span class="no">nil</span><span class="x"> </span><span class="p">{</span><span class="x">
		</span><span class="n">fmt</span><span class="o">.</span><span class="n">Println</span><span class="p">(</span><span class="s">"failed to create listener, err:"</span><span class="p">,</span><span class="x"> </span><span class="n">err</span><span class="p">)</span><span class="x">
		</span><span class="n">os</span><span class="o">.</span><span class="n">Exit</span><span class="p">(</span><span class="m">1</span><span class="p">)</span><span class="x">
	</span><span class="p">}</span><span class="x">
	</span><span class="n">fmt</span><span class="o">.</span><span class="n">Printf</span><span class="p">(</span><span class="s">"listening on %s, prefix: %s</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span><span class="x"> </span><span class="n">listener</span><span class="o">.</span><span class="n">Addr</span><span class="p">(),</span><span class="x"> </span><span class="n">prefix</span><span class="p">)</span><span class="x">

	</span><span class="c">// listen for new connections</span><span class="x">
	</span><span class="k">for</span><span class="x"> </span><span class="p">{</span><span class="x">
		</span><span class="n">conn</span><span class="p">,</span><span class="x"> </span><span class="n">err</span><span class="x"> </span><span class="o">:=</span><span class="x"> </span><span class="n">listener</span><span class="o">.</span><span class="n">Accept</span><span class="p">()</span><span class="x">
		</span><span class="k">if</span><span class="x"> </span><span class="n">err</span><span class="x"> </span><span class="o">!=</span><span class="x"> </span><span class="no">nil</span><span class="x"> </span><span class="p">{</span><span class="x">
			</span><span class="n">fmt</span><span class="o">.</span><span class="n">Println</span><span class="p">(</span><span class="s">"failed to accept connection, err:"</span><span class="p">,</span><span class="x"> </span><span class="n">err</span><span class="p">)</span><span class="x">
			</span><span class="k">continue</span><span class="x">
		</span><span class="p">}</span><span class="x">

		</span><span class="c">// pass an accepted connection to a handler goroutine</span><span class="x">
		</span><span class="k">go</span><span class="x"> </span><span class="n">handleConnection</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span><span class="x"> </span><span class="n">prefix</span><span class="p">)</span><span class="x">
	</span><span class="p">}</span><span class="x">
</span><span class="p">}</span><span class="x">

</span><span class="c">// handleConnection handles the lifetime of a connection</span><span class="x">
</span><span class="k">func</span><span class="x"> </span><span class="n">handleConnection</span><span class="p">(</span><span class="n">conn</span><span class="x"> </span><span class="n">net</span><span class="o">.</span><span class="n">Conn</span><span class="p">,</span><span class="x"> </span><span class="n">prefix</span><span class="x"> </span><span class="kt">string</span><span class="p">)</span><span class="x"> </span><span class="p">{</span><span class="x">
	</span><span class="k">defer</span><span class="x"> </span><span class="n">conn</span><span class="o">.</span><span class="n">Close</span><span class="p">()</span><span class="x">
	</span><span class="n">reader</span><span class="x"> </span><span class="o">:=</span><span class="x"> </span><span class="n">bufio</span><span class="o">.</span><span class="n">NewReader</span><span class="p">(</span><span class="n">conn</span><span class="p">)</span><span class="x">
	</span><span class="k">for</span><span class="x"> </span><span class="p">{</span><span class="x">
		</span><span class="c">// read client request data</span><span class="x">
		</span><span class="n">bytes</span><span class="p">,</span><span class="x"> </span><span class="n">err</span><span class="x"> </span><span class="o">:=</span><span class="x"> </span><span class="n">reader</span><span class="o">.</span><span class="n">ReadBytes</span><span class="p">(</span><span class="kt">byte</span><span class="p">(</span><span class="sc">'\n'</span><span class="p">))</span><span class="x">
		</span><span class="k">if</span><span class="x"> </span><span class="n">err</span><span class="x"> </span><span class="o">!=</span><span class="x"> </span><span class="no">nil</span><span class="x"> </span><span class="p">{</span><span class="x">
			</span><span class="k">if</span><span class="x"> </span><span class="n">err</span><span class="x"> </span><span class="o">!=</span><span class="x"> </span><span class="n">io</span><span class="o">.</span><span class="n">EOF</span><span class="x"> </span><span class="p">{</span><span class="x">
				</span><span class="n">fmt</span><span class="o">.</span><span class="n">Println</span><span class="p">(</span><span class="s">"failed to read data, err:"</span><span class="p">,</span><span class="x"> </span><span class="n">err</span><span class="p">)</span><span class="x">
			</span><span class="p">}</span><span class="x">
			</span><span class="k">return</span><span class="x">
		</span><span class="p">}</span><span class="x">
		</span><span class="n">fmt</span><span class="o">.</span><span class="n">Printf</span><span class="p">(</span><span class="s">"request: %s"</span><span class="p">,</span><span class="x"> </span><span class="n">bytes</span><span class="p">)</span><span class="x">

		</span><span class="c">// prepend prefix and send as response</span><span class="x">
		</span><span class="n">line</span><span class="x"> </span><span class="o">:=</span><span class="x"> </span><span class="n">fmt</span><span class="o">.</span><span class="n">Sprintf</span><span class="p">(</span><span class="s">"%s %s"</span><span class="p">,</span><span class="x"> </span><span class="n">prefix</span><span class="p">,</span><span class="x"> </span><span class="n">bytes</span><span class="p">)</span><span class="x">
		</span><span class="n">fmt</span><span class="o">.</span><span class="n">Printf</span><span class="p">(</span><span class="s">"response: %s"</span><span class="p">,</span><span class="x"> </span><span class="n">line</span><span class="p">)</span><span class="x">
		</span><span class="n">conn</span><span class="o">.</span><span class="n">Write</span><span class="p">([]</span><span class="kt">byte</span><span class="p">(</span><span class="n">line</span><span class="p">))</span><span class="x">
	</span><span class="p">}</span><span class="x">
</span><span class="p">}</span><span class="x">
</span></code></pre></div></div>

<p>To test this program, simply copy the code into a file named <code class="highlighter-rouge">main.go</code> and run
it as shown below.</p>

<div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">$</span> go run <span class="nt">-v</span> main.go 9000 hello
<span class="go">listening on [::]:9000, prefix: hello
</span></code></pre></div></div>

<p>We can now interact with this program over TCP via <code class="highlighter-rouge">nc</code> (<a href="https://en.wikipedia.org/wiki/Netcat">Netcat</a>).
To send a request, we can use a BusyBox container as shown below.</p>

<div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">$</span> docker run <span class="nt">-it</span> <span class="nt">--rm</span> busybox sh <span class="nt">-c</span> <span class="s1">'echo world | nc docker.for.mac.localhost 9000'</span>
<span class="go">hello world
</span></code></pre></div></div>

<p>As you see, the request “world” was prepended with “hello” which resulted in the
“hello world” response. Note that I’m executing the BusyBox container over
<a href="https://docs.docker.com/docker-for-mac/">Docker for Mac</a> which is why I access
the TCP Echo Server via <code class="highlighter-rouge">docker.for.mac.localhost</code> instead of <code class="highlighter-rouge">localhost</code>.</p>

<h2 id="containerizing-the-tcp-echo-server">Containerizing The TCP Echo Server</h2>

<p>Since we eventually want to run the TCP Echo Server over a Kubernetes cluster,
let’s now put it in a container and publish the image to <a href="https://hub.docker.com/">Docker Hub</a>.</p>

<p>Firstly, we create a <code class="highlighter-rouge">Dockerfile</code> with the following contents.</p>

<div class="language-dockerfile highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># build a main binary using the golang container</span>
<span class="k">FROM</span><span class="s"> golang:1.11 as builder</span>
<span class="k">WORKDIR</span><span class="s"> /go/src/github.com/venilnoronha/tcp-echo-server/</span>
<span class="k">COPY</span><span class="s"> main.go .</span>
<span class="k">RUN </span><span class="nv">CGO_ENABLED</span><span class="o">=</span>0 <span class="nv">GOOS</span><span class="o">=</span>linux go build <span class="nt">-a</span> <span class="nt">-installsuffix</span> cgo <span class="nt">-o</span> main main.go

<span class="c"># copy the main binary to a separate container based on alpine</span>
<span class="k">FROM</span><span class="s"> alpine:3.8</span>
<span class="k">RUN </span>apk <span class="nt">--no-cache</span> add ca-certificates
<span class="k">WORKDIR</span><span class="s"> /bin/</span>
<span class="k">COPY</span><span class="s"> --from=builder /go/src/github.com/venilnoronha/tcp-echo-server/main .</span>
<span class="k">ENTRYPOINT</span><span class="s"> [ "/bin/main" ]</span>
<span class="k">CMD</span><span class="s"> [ "9000", "hello" ]</span>
<span class="k">EXPOSE</span><span class="s"> 9000</span>
</code></pre></div></div>

<p>We now build the container and publish the image to Docker Hub as shown below.</p>

<div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">$</span> docker build <span class="nt">-t</span> vnoronha/tcp-echo-server:latest <span class="nb">.</span>
<span class="go">Sending build context to Docker daemon  60.93kB
</span><span class="c">...
</span><span class="go">Successfully built d172af115e18
Successfully tagged vnoronha/tcp-echo-server:latest

</span><span class="gp">$</span> docker push vnoronha/tcp-echo-server:latest
<span class="go">The push refers to repository [docker.io/vnoronha/tcp-echo-server]
b4cc76510de6: Pushed
</span><span class="c">...
</span><span class="go">latest: digest: sha256:0a45b5a0d362db6aa9154717ee3f2b... size: 949
</span></code></pre></div></div>

<h2 id="deploying-the-tcp-echo-server-on-kubernetes">Deploying The TCP Echo Server On Kubernetes</h2>

<h3 id="service-configuration">Service Configuration</h3>

<p>We want to deploy 2 versions of the TCP Echo Server, both with different
prefixes to show the routing behavior. To do so, we create <code class="highlighter-rouge">service.yaml</code> with
a Kubernetes <a href="https://kubernetes.io/docs/concepts/services-networking/service/">Service</a>
and 2 <a href="https://kubernetes.io/docs/concepts/workloads/controllers/deployment/">Deployments</a>
for the 2 different versions of TCP Echo Server we want to run.</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">apiVersion</span><span class="pi">:</span> <span class="s">v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">Service</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">tcp-echo-server</span>
  <span class="na">labels</span><span class="pi">:</span>
    <span class="na">app</span><span class="pi">:</span> <span class="s">tcp-echo-server</span>
    <span class="na">istio</span><span class="pi">:</span> <span class="s">ingressgateway</span> <span class="c1"># use istio default controller</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">selector</span><span class="pi">:</span>
    <span class="na">app</span><span class="pi">:</span> <span class="s">tcp-echo-server</span>
  <span class="na">ports</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">port</span><span class="pi">:</span> <span class="s">9000</span>
    <span class="na">name</span><span class="pi">:</span> <span class="s">tcp</span>
<span class="nn">---</span>
<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">extensions/v1beta1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">Deployment</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">tcp-echo-server-v1</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">replicas</span><span class="pi">:</span> <span class="s">1</span>
  <span class="na">template</span><span class="pi">:</span>
    <span class="na">metadata</span><span class="pi">:</span>
      <span class="na">labels</span><span class="pi">:</span>
        <span class="na">app</span><span class="pi">:</span> <span class="s">tcp-echo-server</span>
        <span class="na">version</span><span class="pi">:</span> <span class="s">v1</span>
    <span class="na">spec</span><span class="pi">:</span>
      <span class="na">containers</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">tcp-echo-server</span>
        <span class="na">image</span><span class="pi">:</span> <span class="s">vnoronha/tcp-echo-server:latest</span>
        <span class="na">args</span><span class="pi">:</span> <span class="pi">[</span> <span class="s2">"</span><span class="s">9000"</span><span class="pi">,</span> <span class="s2">"</span><span class="s">one"</span> <span class="pi">]</span> <span class="c1"># prefix: one</span>
        <span class="na">imagePullPolicy</span><span class="pi">:</span> <span class="s">IfNotPresent</span>
        <span class="na">ports</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="na">containerPort</span><span class="pi">:</span> <span class="s">9000</span>
<span class="nn">---</span>
<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">extensions/v1beta1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">Deployment</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">tcp-echo-server-v2</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">replicas</span><span class="pi">:</span> <span class="s">1</span>
  <span class="na">template</span><span class="pi">:</span>
    <span class="na">metadata</span><span class="pi">:</span>
      <span class="na">labels</span><span class="pi">:</span>
        <span class="na">app</span><span class="pi">:</span> <span class="s">tcp-echo-server</span>
        <span class="na">version</span><span class="pi">:</span> <span class="s">v2</span>
    <span class="na">spec</span><span class="pi">:</span>
      <span class="na">containers</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">tcp-echo-server</span>
        <span class="na">image</span><span class="pi">:</span> <span class="s">vnoronha/tcp-echo-server:latest</span>
        <span class="na">args</span><span class="pi">:</span> <span class="pi">[</span> <span class="s2">"</span><span class="s">9000"</span><span class="pi">,</span> <span class="s2">"</span><span class="s">two"</span> <span class="pi">]</span> <span class="c1"># prefix: two</span>
        <span class="na">imagePullPolicy</span><span class="pi">:</span> <span class="s">IfNotPresent</span>
        <span class="na">ports</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="na">containerPort</span><span class="pi">:</span> <span class="s">9000</span>
</code></pre></div></div>

<h3 id="deploying-minikube">Deploying Minikube</h3>

<p><a href="https://kubernetes.io/docs/setup/minikube/">Minikube</a> serves as a great tool
for locally developing on Kubernetes. I’ve started my Minikube instance with the
following command.</p>

<div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">$</span> minikube start <span class="nt">--bootstrapper</span> kubeadm       <span class="se">\</span>
                 <span class="nt">--memory</span><span class="o">=</span>8192                <span class="se">\</span>
                 <span class="nt">--cpus</span><span class="o">=</span>4                     <span class="se">\</span>
                 <span class="nt">--kubernetes-version</span><span class="o">=</span>v1.10.0 <span class="se">\</span>
                 <span class="nt">--vm-driver</span><span class="o">=</span>virtualbox
<span class="go">Starting local Kubernetes v1.10.0 cluster...
</span><span class="c">...
</span><span class="go">Kubectl is now configured to use the cluster.
Loading cached images from config file.
</span></code></pre></div></div>

<h3 id="installing-istio">Installing Istio</h3>

<p>At the time of writing this article, Istio 1.1.0 wasn’t released. Therefore,
I resorted to an Istio <a href="https://gcsweb.istio.io/gcs/istio-prerelease/daily-build/master-20181017-09-15/">Daily Pre-Release</a>
to demonstrate the new feature. Please refer to the <a href="https://istio.io/docs/setup/kubernetes/download-release/">Istio Docs</a>
to learn to download and configure Istio.</p>

<p>Once configured, here’s an easy way to fully deploy Istio components.</p>

<div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">$</span> kubectl apply <span class="nt">-f</span> install/kubernetes/helm/istio/templates/crds.yaml
<span class="go">customresourcedefinition.apiextensions.k8s.io/virtualservices.networking.istio.io created
</span><span class="c">...
</span><span class="go">customresourcedefinition.apiextensions.k8s.io/templates.config.istio.io created
customresourcedefinition.apiextensions.k8s.io/handlers.config.istio.io created

</span><span class="gp">$</span> kubectl apply <span class="nt">-f</span> install/kubernetes/istio-demo.yaml
<span class="go">namespace/istio-system created
</span><span class="c">...
</span><span class="go">destinationrule.networking.istio.io/istio-policy created
destinationrule.networking.istio.io/istio-telemetry created 
</span></code></pre></div></div>

<h3 id="deploying-tcp-echo-servers-with-istio-proxies">Deploying TCP Echo Servers With Istio Proxies</h3>

<p>Since we want to demonstrate Istio’s routing mechanics, let’s deploy the
<code class="highlighter-rouge">tcp-echo-server</code> with the Istio Proxy side-car as shown below.</p>

<div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">$</span> kubectl apply <span class="nt">-f</span> &lt;<span class="o">(</span>istioctl kube-inject <span class="nt">-f</span> service.yaml<span class="o">)</span>
<span class="go">service/tcp-echo-server created
deployment.extensions/tcp-echo-server-v1 created
deployment.extensions/tcp-echo-server-v2 created
</span></code></pre></div></div>

<p>We can verify that the services are running via the following commands.</p>

<div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">$</span> kubectl get pods
<span class="go">NAME                                  READY     STATUS    RESTARTS   AGE
tcp-echo-server-v1-78684f5697-sv5r5   2/2       Running   0          56s
tcp-echo-server-v2-74bf9999c8-hhhf9   2/2       Running   0          56s

</span><span class="gp">$</span> kubectl logs tcp-echo-server-v1-78684f5697-sv5r5 tcp-echo-server
<span class="go">listening on [::]:9000, prefix: one

</span><span class="gp">$</span> kubectl logs tcp-echo-server-v2-74bf9999c8-hhhf9 tcp-echo-server
<span class="go">listening on [::]:9000, prefix: two
</span></code></pre></div></div>

<h2 id="weighted-tcp-routing-with-istio">Weighted TCP Routing With Istio</h2>

<p>This is the final part of this exercise where we define a <code class="highlighter-rouge">VirtualService</code>,
<code class="highlighter-rouge">DestinationRule</code> and a <code class="highlighter-rouge">Gateway</code> with weighted routes and verify the system
behavior.</p>

<h3 id="routing-configuration">Routing Configuration</h3>

<p>We create a <code class="highlighter-rouge">DestinationRule</code> with 2 <code class="highlighter-rouge">subsets</code> to represent the 2 versions of
the TCP Echo Server. The <code class="highlighter-rouge">Gateway</code> allows traffic to access the services on TCP
port <code class="highlighter-rouge">31400</code>. Finally, the <code class="highlighter-rouge">VirtualService</code> specifies that 80% of the traffic
must be routed to TCP Echo Server v1 and 20% to v2.</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">apiVersion</span><span class="pi">:</span> <span class="s">networking.istio.io/v1alpha3</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">DestinationRule</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">destination</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">host</span><span class="pi">:</span> <span class="s">tcp-echo-server</span>
  <span class="na">subsets</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">v1</span>
    <span class="na">labels</span><span class="pi">:</span>
      <span class="na">version</span><span class="pi">:</span> <span class="s">v1</span>
  <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">v2</span>
    <span class="na">labels</span><span class="pi">:</span>
      <span class="na">version</span><span class="pi">:</span> <span class="s">v2</span>
<span class="nn">---</span>
<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">networking.istio.io/v1alpha3</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">Gateway</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">gateway</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">selector</span><span class="pi">:</span>
    <span class="na">istio</span><span class="pi">:</span> <span class="s">ingressgateway</span>
  <span class="na">servers</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">port</span><span class="pi">:</span>
      <span class="na">number</span><span class="pi">:</span> <span class="s">31400</span>
      <span class="na">name</span><span class="pi">:</span> <span class="s">tcp</span>
      <span class="na">protocol</span><span class="pi">:</span> <span class="s">TCP</span>
    <span class="na">hosts</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="s2">"</span><span class="s">*"</span>
<span class="nn">---</span>
<span class="na">apiVersion</span><span class="pi">:</span> <span class="s">networking.istio.io/v1alpha3</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">VirtualService</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">route</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">hosts</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="s2">"</span><span class="s">*"</span>
  <span class="na">gateways</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="s">gateway</span>
  <span class="na">tcp</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">match</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">port</span><span class="pi">:</span> <span class="s">31400</span>
    <span class="na">route</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">destination</span><span class="pi">:</span>
        <span class="na">host</span><span class="pi">:</span> <span class="s">tcp-echo-server</span>
        <span class="na">port</span><span class="pi">:</span>
          <span class="na">number</span><span class="pi">:</span> <span class="s">9000</span>
        <span class="na">subset</span><span class="pi">:</span> <span class="s">v1</span>
      <span class="na">weight</span><span class="pi">:</span> <span class="s">80</span>
    <span class="pi">-</span> <span class="na">destination</span><span class="pi">:</span>
        <span class="na">host</span><span class="pi">:</span> <span class="s">tcp-echo-server</span>
        <span class="na">port</span><span class="pi">:</span>
          <span class="na">number</span><span class="pi">:</span> <span class="s">9000</span>
        <span class="na">subset</span><span class="pi">:</span> <span class="s">v2</span>
      <span class="na">weight</span><span class="pi">:</span> <span class="s">20</span>
</code></pre></div></div>

<h3 id="deploying-the-route-configuration">Deploying The Route Configuration</h3>

<p>To apply the configuration, copy it to a file named <code class="highlighter-rouge">route-config.yaml</code> and
install it via the following command.</p>

<div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="go">kubectl apply -f route-config.yaml
destinationrule.networking.istio.io/destination created
gateway.networking.istio.io/gateway created
virtualservice.networking.istio.io/route created
</span></code></pre></div></div>

<h3 id="verifying-istios-tcp-routing-behavior">Verifying Istio’s TCP Routing Behavior</h3>

<p>Let’s first <a href="https://istio.io/docs/tasks/traffic-management/ingress/#determining-the-ingress-ip-and-ports">determine the Ingress IP</a>.</p>

<div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">$</span> minikube ip
<span class="go">192.168.99.100
</span></code></pre></div></div>

<p>We can now send a few requests to the weight balanced TCP Echo Server via the
Ingress.</p>

<div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">$</span> <span class="k">for </span>i <span class="k">in</span> <span class="o">{</span>1..10<span class="o">}</span><span class="p">;</span> <span class="k">do</span>
<span class="gp">for&gt;</span> docker run <span class="nt">-it</span> <span class="nt">--rm</span> busybox sh <span class="nt">-c</span> <span class="s1">'(date; sleep 1) | nc 192.168.99.100 31400'</span>
<span class="gp">for&gt;</span> <span class="k">done</span>
<span class="go">one Sat Oct 20 04:38:05 UTC 2018
two Sat Oct 20 04:38:07 UTC 2018
two Sat Oct 20 04:38:09 UTC 2018
one Sat Oct 20 04:38:12 UTC 2018
one Sat Oct 20 04:38:14 UTC 2018
one Sat Oct 20 04:38:17 UTC 2018
one Sat Oct 20 04:38:19 UTC 2018
one Sat Oct 20 04:38:22 UTC 2018
one Sat Oct 20 04:38:24 UTC 2018
two Sat Oct 20 04:38:27 UTC 2018
</span></code></pre></div></div>

<p>As you see, about 80% of the requests have a prefix of “one” and the rest 20%
have a prefix of “two”. This proves that the weighted TCP routes are indeed in
effect.</p>

<p>The diagram below should give you a good idea as to how the Istio landscape
for this demonstration looks like.</p>

<p><img src="assets/images/2018-10-19-raw-tcp-traffic-shaping-with-istio-1.1.0/architecture.svg" alt="Architecture" /></p>

<h2 id="cleanup">Cleanup</h2>

<p>Just delete the Minikube deployment, like so:</p>

<div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">$</span> minikube stop <span class="o">&amp;&amp;</span> minikube delete
<span class="go">Stopping local Kubernetes cluster...
Machine stopped.
Deleting local Kubernetes cluster...
Machine deleted.
</span></code></pre></div></div>

<h2 id="conclusion">Conclusion</h2>

<p>As shown in this article, it’s quite easy to configure weighted TCP routes via
the upcoming Istio 1.1.0 release. Also, this article should give you a good
idea on constructing your own weighted TCP routes, and shaping your TCP traffic
from the ground up!</p>

<hr />

<p>As always, please feel free to reach out with questions or comments.</p>

<p><strong>Disclaimer:</strong> My postings are my own and don’t necessarily represent VMware’s positions, strategies or opinions.</p>

                </div>
            </section>

            <!-- Email subscribe form at the bottom of the page -->
            

            <footer class="post-full-footer">
                <!-- Everything inside the #author tags pulls data from the author -->
                <!-- #author-->
                
                    
                        <section class="author-card">
                            
                                <img class="author-profile-image" src="/assets/images/venilnoronha.jpg" alt="venilnoronha" />
                            
                            <section class="author-card-content">
                                <h4 class="author-card-name"><a href="/author/venilnoronha">Venil Noronha</a></h4>
                                
                                    <p>Open Source Enthusiast</p>
                                
                            </section>
                        </section>
                        <div class="post-full-footer-right">
                            <a class="author-card-button" href="/author/venilnoronha">Read More</a>
                        </div>
                    
                
                <!-- /author  -->
            </footer>

            <!-- If you use Disqus comments, just uncomment this block.
            The only thing you need to change is "test-apkdzgmqhj" - which
            should be replaced with your own Disqus site-id. -->
            
                <section class="post-full-comments">
                    <div id="disqus_thread"></div>
                    <script>
                        var disqus_config = function () {
                            this.page.url = 'https://venilnoronha.io/raw-tcp-traffic-shaping-with-istio-1.1.0';
                            this.page.identifier = 'Raw TCP Traffic Shaping with Istio 1.1.0';
                        };
                        (function() {
                            var d = document, s = d.createElement('script');
                            s.src = 'https://venilnoronha-io.disqus.com/embed.js';
                            s.setAttribute('data-timestamp', +new Date());
                            (d.head || d.body).appendChild(s);
                        })();
                    </script>
                </section>
            

        </article>

    </div>
</main>

<!-- Links to Previous/Next posts -->
<aside class="read-next outer">
    <div class="inner">
        <div class="read-next-feed">
            
                
                
                
                
                    <article class="read-next-card"
                        
                            style="background-image: url(/assets/images/blog-cover.jpg)"
                        
                    >
                        <header class="read-next-card-header">
                            <small class="read-next-card-header-sitetitle">&mdash; Venil Noronha &mdash;</small>
                            
                                <h3 class="read-next-card-header-title"><a href="/tag/distributed-systems/">Distributed systems</a></h3>
                            
                        </header>
                        <div class="read-next-divider"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 14.5s2 3 5 3 5.5-2.463 5.5-5.5S21 6.5 18 6.5c-5 0-7 11-12 11C2.962 17.5.5 15.037.5 12S3 6.5 6 6.5s4.5 3.5 4.5 3.5"/></svg>
</div>
                        <div class="read-next-card-content">
                            <ul>
                                
                                
                                  
                                    
                                  
                                
                                  
                                    
                                        
                                        
                                            <li><a href="/set-sail-a-production-ready-istio-adapter">Set sail a production-ready Istio Adapter</a></li>
                                        
                                    
                                  
                                
                                  
                                    
                                        
                                        
                                            <li><a href="/a-step-by-step-guide-to-mtls-in-go">A step by step guide to mTLS in Go</a></li>
                                        
                                    
                                  
                                
                                  
                                    
                                        
                                        
                                            <li><a href="/designing-asynchronous-functions-with-go">Designing Asynchronous Functions with Go</a></li>
                                        
                                    
                                  
                                
                                  
                                    
                                        
                                        
                                    
                                  
                                
                                  
                                    
                                        
                                        
                                    
                                  
                                
                            </ul>
                        </div>
                        <footer class="read-next-card-footer">
                            <a href="/tag/distributed-systems/">
                                
                                    See all 6 posts  →
                                
                            </a>
                        </footer>
                    </article>
                
            

            <!-- If there's a next post, display it using the same markup included from - partials/post-card.hbs -->
            

            <!-- If there's a previous post, display it using the same markup included from - partials/post-card.hbs -->
            
                
    <article class="post-card post-template">
        
            <a class="post-card-image-link" href="/set-sail-a-production-ready-istio-adapter">
                <div class="post-card-image" style="background-image: url(/assets/images/2018-10-07-set-sail-a-production-ready-istio-adapter/banner.jpg)"></div>
            </a>
        
        <div class="post-card-content">
            <a class="post-card-content-link" href="/set-sail-a-production-ready-istio-adapter">
                <header class="post-card-header">
                    
                        
                            
                                <span class="post-card-tags">Distributed systems</span>
                            
                        
                    

                    <h2 class="post-card-title">Set sail a production-ready Istio Adapter</h2>
                </header>
                <section class="post-card-excerpt">
                    <p>So, you’ve walked through the Istio Mixer Adapter guide and want to now publish your own amazing adapter? This post will run you through the process of setting sail your own adapter on</p>
                </section>
            </a>
            <footer class="post-card-meta">
                
                    
                        
                        <img class="author-profile-image" src="/assets/images/venilnoronha.jpg" alt="Venil Noronha" />
                        
                        <span class="post-card-author">
                            <a href="/author/venilnoronha/">Venil Noronha</a>
                        </span>
                    
                
            </footer>
        </div>
    </article>

            

        </div>
    </div>
</aside>

<!-- Floating header which appears on-scroll, included from includes/floating-header.hbs -->
<div class="floating-header">
    <div class="floating-header-logo">
        <a href="https://venilnoronha.io/">
            
                <img src="/assets/images/favicon.png" alt="Venil Noronha icon" />
            
            <span>Venil Noronha</span>
        </a>
    </div>
    <span class="floating-header-divider">&mdash;</span>
    <div class="floating-header-title">Raw TCP Traffic Shaping with Istio 1.1.0</div>
    <div class="floating-header-share">
        <div class="floating-header-share-label">Share this <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
    <path d="M7.5 15.5V4a1.5 1.5 0 1 1 3 0v4.5h2a1 1 0 0 1 1 1h2a1 1 0 0 1 1 1H18a1.5 1.5 0 0 1 1.5 1.5v3.099c0 .929-.13 1.854-.385 2.748L17.5 23.5h-9c-1.5-2-5.417-8.673-5.417-8.673a1.2 1.2 0 0 1 1.76-1.605L7.5 15.5zm6-6v2m-3-3.5v3.5m6-1v2"/>
</svg>
</div>
        <a class="floating-header-share-tw" href="https://twitter.com/share?text=Raw+TCP+Traffic+Shaping+with+Istio+1.1.0&amp;url=https://venilnoronha.io/raw-tcp-traffic-shaping-with-istio-1.1.0"
            onclick="window.open(this.href, 'share-twitter', 'width=550,height=235');return false;">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 32 32"><path d="M30.063 7.313c-.813 1.125-1.75 2.125-2.875 2.938v.75c0 1.563-.188 3.125-.688 4.625a15.088 15.088 0 0 1-2.063 4.438c-.875 1.438-2 2.688-3.25 3.813a15.015 15.015 0 0 1-4.625 2.563c-1.813.688-3.75 1-5.75 1-3.25 0-6.188-.875-8.875-2.625.438.063.875.125 1.375.125 2.688 0 5.063-.875 7.188-2.5-1.25 0-2.375-.375-3.375-1.125s-1.688-1.688-2.063-2.875c.438.063.813.125 1.125.125.5 0 1-.063 1.5-.25-1.313-.25-2.438-.938-3.313-1.938a5.673 5.673 0 0 1-1.313-3.688v-.063c.813.438 1.688.688 2.625.688a5.228 5.228 0 0 1-1.875-2c-.5-.875-.688-1.813-.688-2.75 0-1.063.25-2.063.75-2.938 1.438 1.75 3.188 3.188 5.25 4.25s4.313 1.688 6.688 1.813a5.579 5.579 0 0 1 1.5-5.438c1.125-1.125 2.5-1.688 4.125-1.688s3.063.625 4.188 1.813a11.48 11.48 0 0 0 3.688-1.375c-.438 1.375-1.313 2.438-2.563 3.188 1.125-.125 2.188-.438 3.313-.875z"/></svg>

        </a>
        <a class="floating-header-share-fb" href="https://www.facebook.com/sharer/sharer.php?u=https://venilnoronha.io/raw-tcp-traffic-shaping-with-istio-1.1.0"
            onclick="window.open(this.href, 'share-facebook','width=580,height=296');return false;">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 32 32"><path d="M19 6h5V0h-5c-3.86 0-7 3.14-7 7v3H8v6h4v16h6V16h5l1-6h-6V7c0-.542.458-1 1-1z"/></svg>

        </a>
    </div>
    <progress class="progress" value="0">
        <div class="progress-container">
            <span class="progress-bar"></span>
        </div>
    </progress>
</div>


<!-- /post -->

<!-- The #contentFor helper here will send everything inside it up to the matching #block helper found in default.hbs -->


        <!-- Previous/next page links - displayed on every page -->
        

        <!-- The footer at the very bottom of the screen -->
        <footer class="site-footer outer">
            <div class="site-footer-content inner">
                <section class="copyright"><a href="https://venilnoronha.io/">Venil Noronha</a> &copy; 2018</section>
                <section class="poweredby">Proudly published with <a href="https://jekyllrb.com/">Jekyll</a> &
                    <a href="https://pages.github.com/" target="_blank" rel="noopener">GitHub Pages</a> using
                    <a href="https://github.com/jekyller/jasper2" target="_blank" rel="noopener">Jasper2</a></section>
                <nav class="site-footer-nav">
                    <a href="https://github.com/venilnoronha" target="_blank" rel="noopener">GitHub</a>
                    
                    <a href="https://twitter.com/venilnoronha" target="_blank" rel="noopener">Twitter</a>
                    <a href="https://instagram.com/venilnoronha" target="_blank" rel="noopener">Instagram</a>
                    <a href="https://linkedin.com/in/venilnoronha" target="_blank" rel="noopener">LinkedIn</a>
                </nav>
            </div>
        </footer>

    </div>

    <!-- The big email subscribe modal content -->
    

    <!-- highlight.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.10.0/components/prism-abap.min.js"></script>
    <script>$(document).ready(function() {
      $('pre code').each(function(i, block) {
        hljs.highlightBlock(block);
      });
    });</script>

    <!-- jQuery + Fitvids, which makes all video embeds responsive -->
    <script
        src="https://code.jquery.com/jquery-3.2.1.min.js"
        integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4="
        crossorigin="anonymous">
    </script>
    <script type="text/javascript" src="/assets/js/jquery.fitvids.js"></script>
    <script type="text/javascript" src="https://demo.ghost.io/assets/js/jquery.fitvids.js?v=724281a32e"></script>


    <!-- Paginator increased to "infinit" in _config.yml -->
    <!-- if paginator.posts  -->
    <!-- <script>
        var maxPages = parseInt('');
    </script>
    <script src="/assets/js/infinitescroll.js"></script> -->
    <!-- /endif -->

    


    <!-- Add Google Analytics  -->
    <!-- Google Analytics Tracking code -->
 <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-109280867-1', 'auto');
  ga('send', 'pageview');

 </script>


    <!-- The #block helper will pull in data from the #contentFor other template files. In this case, there's some JavaScript which we only want to use in post.hbs, but it needs to be included down here, after jQuery has already loaded. -->
    
        <script>

// NOTE: Scroll performance is poor in Safari
// - this appears to be due to the events firing much more slowly in Safari.
//   Dropping the scroll event and using only a raf loop results in smoother
//   scrolling but continuous processing even when not scrolling
$(document).ready(function () {
    // Start fitVids
    var $postContent = $(".post-full-content");
    $postContent.fitVids();
    // End fitVids

    var progressBar = document.querySelector('progress');
    var header = document.querySelector('.floating-header');
    var title = document.querySelector('.post-full-title');

    var lastScrollY = window.scrollY;
    var lastWindowHeight = window.innerHeight;
    var lastDocumentHeight = $(document).height();
    var ticking = false;

    function onScroll() {
        lastScrollY = window.scrollY;
        requestTick();
    }

    function onResize() {
        lastWindowHeight = window.innerHeight;
        lastDocumentHeight = $(document).height();
        requestTick();
    }

    function requestTick() {
        if (!ticking) {
            requestAnimationFrame(update);
        }
        ticking = true;
    }

    function update() {
        var trigger = title.getBoundingClientRect().top + window.scrollY;
        var triggerOffset = title.offsetHeight + 35;
        var progressMax = lastDocumentHeight - lastWindowHeight;

        // show/hide floating header
        if (lastScrollY >= trigger + triggerOffset) {
            header.classList.add('floating-active');
        } else {
            header.classList.remove('floating-active');
        }

        progressBar.setAttribute('max', progressMax);
        progressBar.setAttribute('value', lastScrollY);

        ticking = false;
    }

    window.addEventListener('scroll', onScroll, {passive: true});
    window.addEventListener('resize', onResize, false);

    update();
});
</script>

    

    <!-- Ghost outputs important scripts and data with this tag - it should always be the very last thing before the closing body tag -->
    <!-- ghost_foot -->

</body>
</html>
